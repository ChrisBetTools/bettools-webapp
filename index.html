<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>BetTools</title>

<!-- PWA / iOS -->
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root { color-scheme: light dark; }
body {
    margin: 0;
    font-family: -apple-system, system-ui, sans-serif;
    background: #f3f4f6;
    color: #111827;
}

/* Tabs */
.topTabs {
    display: flex;
    background: #e5e7eb;
    border-bottom: 1px solid #d1d5db;
    position: sticky;
    top: 0;
    z-index: 10;
}
.topTabs button {
    flex: 1;
    padding: 11px 4px;
    border: 0;
    background: transparent;
    font-size: 15px;
    font-weight: 600;
    color: #6b7280;
}
.topTabs button.active {
    background: #ffffff;
    color: #111827;
    border-bottom: 3px solid #2563eb;
}

/* Pages */
.page {
    display: none;
    padding: 12px;
}

/* Cards */
.card {
    background: #ffffff;
    border-radius: 12px;
    padding: 14px;
    margin-bottom: 14px;
    box-shadow: 0 4px 10px rgba(15,23,42,0.06);
}
h2 {
    margin: 0 0 8px 0;
    font-size: 18px;
}
p.desc {
    margin: 0 0 10px 0;
    font-size: 13px;
    color: #6b7280;
}

/* Inputs */
label {
    font-size: 13px;
    font-weight: 600;
    display: block;
    margin: 6px 0 2px;
}
input, select {
    width: 100%;
    padding: 9px;
    font-size: 14px;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    box-sizing: border-box;
    background: #f9fafb;
    color: #111827;
}
input:focus, select:focus {
    outline: 2px solid #2563eb;
    outline-offset: 0;
    background: #ffffff;
}

/* Buttons */
.btn {
    width: 100%;
    padding: 11px;
    margin-top: 10px;
    border-radius: 9px;
    border: none;
    font-size: 15px;
    font-weight: 600;
    color: #ffffff;
    background: #2563eb;
    cursor: pointer;
}
.btn.secondary { background: #6b7280; }
.btn.danger { background: #ef4444; }
.btn.small {
    width: auto;
    padding: 4px 8px;
    font-size: 12px;
}
.btn:active { opacity: 0.9; }

/* Result box */
.resultBox {
    margin-top: 10px;
    padding: 10px;
    background: #f9fafb;
    border-radius: 8px;
    font-size: 14px;
}

/* Colors */
.text-gray { color: #6b7280; }
.text-green { color: #16a34a; }
.text-red { color: #ef4444; }
.text-blue { color: #2563eb; }

/* Storico */
table.storico {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}
table.storico th, table.storico td {
    padding: 6px 4px;
    border-bottom: 1px solid #e5e7eb;
}
table.storico th {
    text-align: left;
    font-size: 12px;
    text-transform: uppercase;
    color: #6b7280;
}

/* KPI */
.kpiGrid {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(120px,1fr));
    gap: 10px;
    margin-top: 6px;
}
.kpiItem { text-align: left; }
.kpiValue { font-size: 19px; font-weight: 700; }
.kpiLabel { font-size: 12px; color: #6b7280; }

/* Filters */
.filtersRow {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 8px;
}
.filtersRow select { flex: 1 1 130px; }

/* WinRate */
.winRateWrap {
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.winRateSide {
    width: 25%;
    text-align: center;
}
.winRateSide .value {
    font-size: 22px;
    font-weight: 700;
}
.winRateSide .label {
    font-size: 13px;
    color: #6b7280;
}
.winRateCenter {
    width: 120px;
    height: 120px;
}

/* Range buttons */
.rangeRow {
    display: flex;
    justify-content: flex-end;
    gap: 6px;
    margin-bottom: 6px;
}
.rangeBtn {
    padding: 3px 8px;
    font-size: 11px;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    background: #f3f4f6;
    cursor: pointer;
}
.rangeBtn.active {
    background: #2563eb;
    color: white;
    border-color: #2563eb;
}

/* Modal */
#addModal, #editModal {
    position: fixed;
    inset: 0;
    background: rgba(15,23,42,0.55);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 50;
}
.modalCard {
    background: white;
    border-radius: 14px;
    padding: 16px;
    width: 92%;
    max-width: 420px;
    box-shadow: 0 20px 40px rgba(15,23,42,0.4);
}

/* Dark mode */
@media (prefers-color-scheme: dark) {
    body { background: #111827; color: #f9fafb; }
    .topTabs { background: #1f2937; border-bottom-color:#374151; }
    .topTabs button { color:#9ca3af; }
    .topTabs button.active { background:#111827; color:#f9fafb; }
    .card { background:#1f2937; box-shadow:none; }
    input, select { background:#111827; color:#f9fafb; border-color:#374151; }
    .resultBox { background:#111827; }
    table.storico th, table.storico td { border-bottom-color:#374151; }
    .modalCard { background:#111827; }
}
</style>
</head>
<body>

<!-- TABS -->
<div class="topTabs">
    <button id="tab_calc" class="active" onclick="showTab('calc')">Calcolatori</button>
    <button id="tab_storico" onclick="showTab('storico')">Storico</button>
    <button id="tab_dash" onclick="showTab('dash')">Dashboard</button>
</div>

<!-- ============== PAGINA CALCOLATORI ============== -->
<div id="page_calc" class="page" style="display:block;">

    <!-- Asian Line Intera -->
    <div class="card">
        <h2>Asian Line Intera</h2>
        <p class="desc">
            Simula una linea asiatica intera con due Over. Se Quota B = 0, tutta la puntata va su Quota A.
        </p>

        <label>Puntata Totale (€)</label>
        <input id="al_tot" type="number" step="0.1">

        <label>Quota A – Over Minore</label>
        <input id="al_qA" type="number" step="0.01">

        <label>Quota B – Over Maggiore (0 se non giocata)</label>
        <input id="al_qB" type="number" step="0.01" value="0">

        <button class="btn" onclick="calcolaAsianIntera()">Calcola</button>
        <div id="al_out" class="resultBox" style="display:none;"></div>
        <button class="btn secondary" onclick="apriAddModal('Asian Line Intera')">+ Aggiungi allo storico</button>
    </div>

    <!-- Protezione Void -->
    <div class="card">
        <h2>Protezione Void (Giocata Principale + Copertura)</h2>
        <p class="desc">
            Usa una seconda giocata a quota bassa per coprire quasi la perdita della principale.
            Se Quota B = 0 tutta la puntata va su Quota A.
        </p>

        <label>Puntata Totale (€)</label>
        <input id="pv_tot" type="number" step="0.1">

        <label>Quota A (Giocata principale)</label>
        <input id="pv_qA" type="number" step="0.01">

        <label>Quota B (Copertura – 0 se non giocata)</label>
        <input id="pv_qB" type="number" step="0.01" value="0">

        <button class="btn" onclick="calcolaProtezione()">Calcola</button>
        <div id="pv_out" class="resultBox" style="display:none;"></div>
        <button class="btn secondary" onclick="apriAddModal('Protezione Void')">+ Aggiungi allo storico</button>
    </div>

    <!-- Over Asiatici frazionari -->
    <div class="card">
        <h2>Over Asiatici frazionari (0.25 / 0.75)</h2>
        <p class="desc">
            Dividi la puntata su due Over adiacenti per simulare una linea X.25 o X.75.
        </p>

        <label>Tipo Linea</label>
        <select id="af_tipo">
            <option value="0.25">Over X.25</option>
            <option value="0.75">Over X.75</option>
        </select>

        <label>Valore X (es. 2 =&gt; Over 2.25 / 2.75)</label>
        <input id="af_base" type="number" step="0.5">

        <label>Puntata Totale (€)</label>
        <input id="af_tot" type="number" step="0.1">

        <label>Quota Over Minore</label>
        <input id="af_qLow" type="number" step="0.01">

        <label>Quota Over Maggiore</label>
        <input id="af_qHigh" type="number" step="0.01">

        <button class="btn" onclick="calcolaAsianFraz()">Calcola</button>
        <div id="af_out" class="resultBox" style="display:none;"></div>
        <button class="btn secondary" onclick="apriAddModal('Over Asiatico frazionario')">+ Aggiungi allo storico</button>
    </div>

</div>

<!-- ============== PAGINA STORICO ============== -->
<div id="page_storico" class="page">

    <div class="card">
        <h2>Storico Giocate</h2>

        <div class="filtersRow" style="margin-top:6px;">
            <select id="f_tipo" onchange="renderStorico();">
                <option value="all">Tutti i tipi</option>
                <option value="Asian Line Intera">Asian Line Intera</option>
                <option value="Protezione Void">Protezione Void</option>
                <option value="Over Asiatico frazionario">Over Asiatico frazionario</option>
                <option value="2 More Corner FT">2 More Corner FT</option>
                <option value="Next Goal Home - Pari">Next Goal Home - Pari</option>
                <option value="New Neigh Casa">New Neigh Casa</option>
                <option value="New Dominio Home">New Dominio Home</option>
                <option value="Secondo Goal HT Lite">Secondo Goal HT Lite</option>
            </select>

            <select id="f_periodo" onchange="renderStorico();">
                <option value="tutto">Tutto</option>
                <option value="oggi">Oggi</option>
                <option value="ieri">Ieri</option>
                <option value="sett_corr">Settimana in corso</option>
                <option value="sett_prev">Settimana precedente</option>
                <option value="mese_corr">Mese in corso</option>
                <option value="mese_prev">Mese precedente</option>
            </select>
        </div>

        <div id="storicoBox" style="margin-top:8px;"></div>

        <button class="btn danger" style="margin-top:10px;" onclick="resetStorico()">
            Cancella storico
        </button>
    </div>

</div>

<!-- ============== PAGINA DASHBOARD ============== -->
<div id="page_dash" class="page">

    <div class="card">
        <h2>Dashboard</h2>

        <div class="filtersRow" style="margin-top:6px;">
            <select id="d_tipo" onchange="aggiornaDashboard();">
                <option value="all">Tutti i tipi</option>
                <option value="Asian Line Intera">Asian Line Intera</option>
                <option value="Protezione Void">Protezione Void</option>
                <option value="Over Asiatico frazionario">Over Asiatico frazionario</option>
                <option value="2 More Corner FT">2 More Corner FT</option>
                <option value="Next Goal Home - Pari">Next Goal Home - Pari</option>
                <option value="New Neigh Casa">New Neigh Casa</option>
                <option value="New Dominio Home">New Dominio Home</option>
                <option value="Secondo Goal HT Lite">Secondo Goal HT Lite</option>
            </select>

            <select id="d_periodo" onchange="aggiornaDashboard();">
                <option value="tutto">Tutto</option>
                <option value="oggi">Oggi</option>
                <option value="ieri">Ieri</option>
                <option value="sett_corr">Settimana in corso</option>
                <option value="sett_prev">Settimana precedente</option>
                <option value="mese_corr">Mese in corso</option>
                <option value="mese_prev">Mese precedente</option>
            </select>
        </div>

        <div class="kpiGrid">
            <div class="kpiItem">
                <div id="kpi_profit" class="kpiValue">0€</div>
                <div class="kpiLabel">Total Profit</div>
            </div>
            <div class="kpiItem">
                <div id="kpi_yield" class="kpiValue">0%</div>
                <div class="kpiLabel">Yield</div>
            </div>
            <div class="kpiItem">
                <div id="kpi_odd" class="kpiValue">0</div>
                <div class="kpiLabel">Avg. Odd</div>
            </div>
            <div class="kpiItem">
                <div id="kpi_stake" class="kpiValue">0€</div>
                <div class="kpiLabel">Avg. Stake</div>
            </div>
            <div class="kpiItem">
                <div id="kpi_matches" class="kpiValue">0</div>
                <div class="kpiLabel">Total Matches</div>
            </div>
            <div class="kpiItem">
                <div id="kpi_bets" class="kpiValue">0</div>
                <div class="kpiLabel">Total Bets (A+B)</div>
            </div>
            <div class="kpiItem">
                <div id="kpi_wr_total" class="kpiValue">0%</div>
                <div class="kpiLabel">Winrate Totale (bets)</div>
            </div>
            <div class="kpiItem">
                <div id="kpi_wr_A" class="kpiValue">0%</div>
                <div class="kpiLabel">Winrate Quota A</div>
            </div>
            <div class="kpiItem">
                <div id="kpi_wr_B" class="kpiValue">0%</div>
                <div class="kpiLabel">Winrate Quota B</div>
            </div>
        </div>
    </div>

    <!-- Win Rate -->
    <div class="card">
        <h2 style="text-align:center;">Win Rate</h2>
        <div class="winRateWrap">
            <div class="winRateSide">
                <div id="wr_win" class="value" style="color:#16a34a;">0%</div>
                <div class="label">Won</div>
            </div>
            <div class="winRateCenter">
                <canvas id="chartWinRate" width="120" height="120"></canvas>
            </div>
            <div class="winRateSide">
                <div id="wr_lost" class="value" style="color:#ef4444;">0%</div>
                <div class="label">Lost</div>
            </div>
        </div>
    </div>

    <!-- Profit Chart -->
    <div class="card">
        <h2>Profit Chart</h2>

        <div class="rangeRow">
            <button class="rangeBtn active" data-range="all" onclick="setRange('all')">all</button>
            <button class="rangeBtn" data-range="1m" onclick="setRange('1m')">1m</button>
            <button class="rangeBtn" data-range="6m" onclick="setRange('6m')">6m</button>
            <button class="rangeBtn" data-range="12m" onclick="setRange('12m')">12m</button>
        </div>

        <canvas id="chartProfit" height="220"></canvas>
    </div>

    <!-- Stake engine -->
    <div class="card">
        <h2>Stake consigliato</h2>

        <label>Bankroll iniziale (€)</label>
        <input id="br_start" type="number" step="0.1" oninput="saveBankrollStart(); aggiornaDashboard();">

        <p><strong>Bankroll attuale:</strong> <span id="br_current">-</span></p>
        <p><strong>Δ vs iniziale:</strong> <span id="br_delta">-</span></p>

        <p><strong>Stake Standard:</strong> <span id="stk_std">-</span></p>
        <p><strong>Stake High-Edge:</strong> <span id="stk_high">-</span></p>

        <p id="stk_note" class="text-gray" style="font-size:13px;"></p>
    </div>

</div>

<!-- ============== MODALE AGGIUNTA / EDIT ============== -->
<div id="addModal">
    <div class="modalCard">
        <h2 id="am_title">Aggiungi allo storico</h2>

        <label>Partita</label>
        <input id="am_partita" placeholder="Es: Inter - Liverpool">

        <label>Tipo scommessa</label>
        <select id="am_tipo">
            <option value="Asian Line Intera">Asian Line Intera</option>
            <option value="Protezione Void">Protezione Void</option>
            <option value="Over Asiatico frazionario">Over Asiatico frazionario</option>
            <option value="2 More Corner FT">2 More Corner FT</option>
            <option value="Next Goal Home - Pari">Next Goal Home - Pari</option>
            <option value="New Neigh Casa">New Neigh Casa</option>
            <option value="New Dominio Home">New Dominio Home</option>
            <option value="Secondo Goal HT Lite">Secondo Goal HT Lite</option>
        </select>

        <label>Esito</label>
        <select id="am_esito">
            <option value="Non giocata">Non giocata</option>
            <option value="Vinte entrambe">Vinte entrambe</option>
            <option value="Solo A vinta">Solo A vinta</option>
            <option value="Solo B vinta">Solo B vinta</option>
            <option value="Perse entrambe">Perse entrambe</option>
        </select>

        <button class="btn success" onclick="confermaAddModal()">Salva</button>
        <button class="btn secondary" onclick="chiudiAddModal()">Chiudi</button>
    </div>
</div>

<script>
/* ========= Stato globale ========= */
const LS_KEY = 'bettools_storico';
const LS_BR  = 'bettools_bankroll';

let lastCalc = null;       // {qA,qB,sA,sB}
let editingId = null;      // id riga in edit
let equityRange = 'all';

let winChartObj = null;
let profitChartObj = null;

/* ========= Utility ========= */
function safeNum(v){ const n=parseFloat(v); return isNaN(n)?0:n; }
function todayISO(){ return new Date().toISOString().slice(0,10); }
function cloneDate(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }

/* ========= Tabs ========= */
function showTab(name){
    ['calc','storico','dash'].forEach(p=>{
        document.getElementById('page_'+p).style.display = (p===name?'block':'none');
        document.getElementById('tab_'+p).classList.toggle('active', p===name);
    });
    if(name==='storico') renderStorico();
    if(name==='dash')    aggiornaDashboard();
}

/* ========= LocalStorage ========= */
function loadStorico(){
    try{
        const raw = localStorage.getItem(LS_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr)?arr:[];
    }catch{return [];}
}
function saveStorico(arr){
    localStorage.setItem(LS_KEY, JSON.stringify(arr));
}
function resetStorico(){
    if(!confirm('Cancellare tutto lo storico?')) return;
    localStorage.removeItem(LS_KEY);
    renderStorico();
    aggiornaDashboard();
}
function loadBankrollStart(){
    return safeNum(localStorage.getItem(LS_BR));
}
function saveBankrollStart(){
    const v=safeNum(document.getElementById('br_start').value);
    if(v>0) localStorage.setItem(LS_BR, v.toString());
    else localStorage.removeItem(LS_BR);
}

/* ========= Calcolatore Asian Intera ========= */
function calcolaAsianIntera(){
    const S  = safeNum(al_tot.value);
    const qA = safeNum(al_qA.value);
    const qB = safeNum(al_qB.value);
    const out=al_out;

    if(S<=0 || qA<=1 || qB<0){
        out.style.display='block';
        out.innerHTML='<span class="text-red">Inserisci puntata valida, Quota A &gt; 1 e Quota B ≥ 0.</span>';
        lastCalc=null; return;
    }

    let sA,sB;

    if(qB===0){
        sA=S; sB=0;
        const profitA=sA*(qA-1);
        out.style.display='block';
        out.innerHTML=
          `<b>Punta solo su Over Minore:</b> ${sA.toFixed(2)}€ @ ${qA.toFixed(2)}<br>`+
          `<b>Over Minore vinto:</b> <span class="${profitA>=0?'text-green':'text-red'}">`+
          `${(profitA>=0?'+':'')+profitA.toFixed(2)}€</span>`;
    }else{
        sA = S / qA;
        sB = S - sA;
        const stakeTot = sA + sB;

        const profitSoloA = sA*qA - stakeTot;
        const profitBoth  = sA*qA + sB*qB - stakeTot;

        out.style.display='block';
        out.innerHTML=
          `<b>Punta su Over Minore:</b> ${sA.toFixed(2)}€ @ ${qA.toFixed(2)}<br>`+
          `<b>Punta su Over Maggiore:</b> ${sB.toFixed(2)}€ @ ${qB.toFixed(2)}<br><br>`+
          `<b>Solo Over Minore vinto:</b> <span class="${profitSoloA>=0?'text-green':'text-red'}">`+
          `${(profitSoloA>=0?'+':'')+profitSoloA.toFixed(2)}€</span><br>`+
          `<b>Entrambe Vinte:</b> <span class="${profitBoth>=0?'text-green':'text-red'}">`+
          `${(profitBoth>=0?'+':'')+profitBoth.toFixed(2)}€</span>`;
    }

    lastCalc = { qA, qB, sA, sB };
}

/* ========= Calcolatore Protezione ========= */
function calcolaProtezione(){
    const S  = safeNum(pv_tot.value);
    const qA = safeNum(pv_qA.value);
    const qB = safeNum(pv_qB.value);
    const out=pv_out;

    if(S<=0 || qA<=1 || qB<0){
        out.style.display='block';
        out.innerHTML='<span class="text-red">Inserisci puntata valida, Quota A &gt; 1 e Quota B ≥ 0.</span>';
        lastCalc=null; return;
    }

    let sA,sB;

    if(qB===0){
        sA=S; sB=0;
        const profitA=sA*(qA-1);
        out.style.display='block';
        out.innerHTML=
          `<b>Punta solo su A (principale):</b> ${sA.toFixed(2)}€ @ ${qA.toFixed(2)}<br>`+
          `<b>Solo A vinta:</b> <span class="${profitA>=0?'text-green':'text-red'}">`+
          `${(profitA>=0?'+':'')+profitA.toFixed(2)}€</span>`;
    }else{
        // stakeB tale che vincendo solo B ≈ void
        sB = S / qB;
        sA = S - sB;
        const stakeTot=sA+sB;

        const profitA = sA*qA - stakeTot;
        const profitB = sB*qB - stakeTot;
        const profitBoth = sA*qA + sB*qB - stakeTot;

        out.style.display='block';
        out.innerHTML=
          `<b>Punta su A (principale):</b> ${sA.toFixed(2)}€ @ ${qA.toFixed(2)}<br>`+
          `<b>Punta su B (copertura):</b> ${sB.toFixed(2)}€ @ ${qB.toFixed(2)}<br><br>`+
          `<b>Solo A vinta:</b> <span class="${profitA>=0?'text-green':'text-red'}">`+
          `${(profitA>=0?'+':'')+profitA.toFixed(2)}€</span><br>`+
          `<b>Solo B vinta (quasi void):</b> <span class="${profitB>=0?'text-green':'text-red'}">`+
          `${(profitB>=0?'+':'')+profitB.toFixed(2)}€</span><br>`+
          `<b>Entrambe Vinte:</b> <span class="${profitBoth>=0?'text-green':'text-red'}">`+
          `${(profitBoth>=0?'+':'')+profitBoth.toFixed(2)}€</span>`;
    }

    lastCalc = { qA, qB, sA, sB };
}

/* ========= Asian frazionari ========= */
function testoEsitoAsian(linea,g){
    const base=Math.floor(linea);
    const frac=linea-base;
    const prefix=`Ancora ${g} gol: `;
    if(frac===0.25){
        if(g<=base-1) return prefix+'persa';
        if(g===base)  return prefix+'mezza persa';
        if(g>=base+1) return prefix+'vinta';
    }else if(frac===0.75){
        if(g<=base)   return prefix+'persa';
        if(g===base+1)return prefix+'mezza vinta';
        if(g>=base+2) return prefix+'vinta';
    }
    return prefix+'-';
}
function calcolaAsianFraz(){
    const tipo = safeNum(af_tipo.value); // 0.25 o 0.75
    const base = safeNum(af_base.value);
    const S    = safeNum(af_tot.value);
    const qLow = safeNum(af_qLow.value);
    const qHigh= safeNum(af_qHigh.value);
    const out  = af_out;

    if(S<=0 || qLow<=1 || qHigh<=1 || (tipo!==0.25 && tipo!==0.75)){
        out.style.display='block';
        out.innerHTML='<span class="text-red">Inserisci X, puntata &gt;0, quote &gt;1 e scegli 0.25 / 0.75.</span>';
        lastCalc=null; return;
    }

    const linea = base+tipo;
    let sA = S/2;
    let sB = S-sA;

    let esempi='';
    for(let g=0; g<=base+4; g++){
        esempi+=`<li>${testoEsitoAsian(linea,g)}</li>`;
    }

    out.style.display='block';
    out.innerHTML=
      `<b>Linea:</b> Over ${linea.toFixed(2)}<br>`+
      `<b>Punta su Over ${base.toFixed(0)}:</b> ${sA.toFixed(2)}€ @ ${qLow.toFixed(2)}<br>`+
      `<b>Punta su Over ${(base+0.5).toFixed(1)}:</b> ${sB.toFixed(2)}€ @ ${qHigh.toFixed(2)}<br>`+
      `<p class="text-gray" style="font-size:13px;">Stake diviso 50/50 sui due Over.</p>`+
      `<p><b>Esempi esito:</b></p><ul style="padding-left:16px;font-size:13px;">${esempi}</ul>`;

    lastCalc = { qA:qLow, qB:qHigh, sA, sB };
}

/* ========= Modale Aggiungi / Edit ========= */
function apriAddModal(defaultTipo){
    if(!lastCalc){
        alert('Prima esegui il calcolo.');
        return;
    }
    editingId = null;
    am_title.textContent = 'Aggiungi allo storico';
    am_partita.value = '';
    am_tipo.value = defaultTipo;
    am_esito.value = 'Non giocata';
    addModal.style.display='flex';
}
function chiudiAddModal(){
    addModal.style.display='none';
    editingId = null;
}
function apriEditModal(id){
    const arr=loadStorico();
    const rec=arr.find(r=>r.id===id);
    if(!rec) return;
    editingId = id;
    am_title.textContent = 'Modifica giocata';
    am_partita.value = rec.partita || '';
    am_tipo.value = rec.tipo || 'Asian Line Intera';
    am_esito.value = rec.esito || 'Non giocata';
    addModal.style.display='flex';
}
function calcolaProfit(rec){
    const stakeTot = rec.stakeA + rec.stakeB;
    if(rec.esito==='Vinte entrambe'){
        return rec.stakeA*(rec.quotaA-1)+rec.stakeB*(rec.quotaB-1);
    }else if(rec.esito==='Solo A vinta'){
        return rec.stakeA*(rec.quotaA-1) - rec.stakeB;
    }else if(rec.esito==='Solo B vinta'){
        return rec.stakeB*(rec.quotaB-1) - rec.stakeA;
    }else if(rec.esito==='Perse entrambe'){
        return -stakeTot;
    }else{
        return 0;
    }
}
function confermaAddModal(){
    const partita = am_partita.value.trim();
    const tipo    = am_tipo.value;
    const esito   = am_esito.value;

    if(editingId!==null){
        // EDIT ESISTENTE
        const arr = loadStorico();
        const idx = arr.findIndex(r=>r.id===editingId);
        if(idx===-1){ chiudiAddModal(); return; }
        const rec = arr[idx];
        rec.partita = partita;
        rec.tipo    = tipo;
        rec.esito   = esito;
        rec.profit  = calcolaProfit(rec);
        saveStorico(arr);
    }else{
        // NUOVA RIGA DA CALCOLO
        if(!lastCalc){
            alert('Prima esegui il calcolo.');
            return;
        }
        const rec = {
            id: Date.now(),
            data: todayISO(),
            partita,
            tipo,
            quotaA: lastCalc.qA,
            quotaB: lastCalc.qB || 0,
            stakeA: lastCalc.sA || 0,
            stakeB: lastCalc.sB || 0,
            esito,
            profit: 0
        };
        rec.profit = calcolaProfit(rec);
        const arr = loadStorico();
        arr.push(rec);
        saveStorico(arr);
    }

    chiudiAddModal();
    renderStorico();
    aggiornaDashboard();
}

/* ========= Filtri periodo ========= */
function applyPeriodo(arr, periodo){
    if(periodo==='tutto') return arr;
    const today = cloneDate(new Date());

    function match(r){
        if(!r.data) return true;
        const d = cloneDate(new Date(r.data));
        if(periodo==='oggi')  return d.getTime()===today.getTime();
        if(periodo==='ieri'){
            const y=cloneDate(today); y.setDate(y.getDate()-1);
            return d.getTime()===y.getTime();
        }
        if(periodo==='sett_corr'){
            const day=today.getDay()||7;
            const start=cloneDate(today); start.setDate(start.getDate()-(day-1));
            return d>=start;
        }
        if(periodo==='sett_prev'){
            const day=today.getDay()||7;
            const monday=cloneDate(today); monday.setDate(monday.getDate()-(day-1));
            const start=cloneDate(monday); start.setDate(start.getDate()-7);
            const end=cloneDate(start); end.setDate(end.getDate()+6);
            return d>=start && d<=end;
        }
        if(periodo==='mese_corr'){
            return r.data.slice(0,7)===today.toISOString().slice(0,7);
        }
        if(periodo==='mese_prev'){
            const tmp=cloneDate(today); tmp.setMonth(tmp.getMonth()-1);
            return r.data.slice(0,7)===tmp.toISOString().slice(0,7);
        }
        return true;
    }

    return arr.filter(match);
}

/* ========= Render Storico ========= */
function renderStorico(){
    const box=storicoBox;
    const all=loadStorico();
    let arr=all.slice();

    const tipo   = f_tipo.value || 'all';
    const periodo= f_periodo.value || 'tutto';

    if(tipo!=='all') arr=arr.filter(r=>r.tipo===tipo);
    arr=applyPeriodo(arr, periodo);

    if(!arr.length){
        box.innerHTML='<p class="text-gray">Nessuna giocata per i filtri selezionati.</p>';
        return;
    }

    arr.sort((a,b)=> (a.data===b.data? a.id-b.id : (a.data>b.data?1:-1)));

    let html='<table class="storico"><tr>'+
        '<th>Data</th><th>Partita</th><th>Tipo</th><th>Esito</th><th>Profitto</th><th></th></tr>';

    arr.forEach(r=>{
        const colEsito = (r.esito==='Non giocata') ? 'text-red' : 'text-blue';
        const colProf  = r.profit>=0 ? 'text-green' : 'text-red';
        html+=`<tr>
            <td>${r.data}</td>
            <td>${r.partita||'-'}</td>
            <td>${r.tipo||'-'}</td>
            <td class="${colEsito}">${r.esito}</td>
            <td class="${colProf}">${(r.profit>=0?'+':'')+r.profit.toFixed(2)}€</td>
            <td><button class="btn small secondary" onclick="apriEditModal(${r.id})">✏️</button></td>
        </tr>`;
    });

    html+='</table>';
    box.innerHTML=html;
}

/* ========= Range Profit Chart ========= */
function setRange(r){
    equityRange=r;
    document.querySelectorAll('.rangeBtn').forEach(btn=>{
        btn.classList.toggle('active', btn.dataset.range===r);
    });
    aggiornaDashboard();
}

/* ========= Dashboard ========= */
function getDashboardFiltered(){
    const all=loadStorico();

    const tipo   = d_tipo.value || 'all';
    const periodo= d_periodo.value || 'tutto';

    let arr=all.slice();
    if(tipo!=='all') arr=arr.filter(r=>r.tipo===tipo);
    arr=applyPeriodo(arr, periodo);

    // range equity
    const today=cloneDate(new Date());
    arr=arr.filter(r=>{
        if(!r.data) return true;
        const d=cloneDate(new Date(r.data));
        const diff=(today-d)/(1000*60*60*24);
        if(equityRange==='1m') return diff<=30;
        if(equityRange==='6m') return diff<=180;
        if(equityRange==='12m')return diff<=365;
        return true;
    });

    return {arr, all};
}

function aggiornaDashboard(){
    const {arr,all} = getDashboardFiltered();

    let profit=0, stakeTot=0;
    let oddSum=0, oddCount=0;
    let matches=arr.length;
    let countA=0, countB=0;
    let winA=0, winB=0;

    arr.forEach(r=>{
        profit+=r.profit;
        const stake=r.stakeA+r.stakeB;
        stakeTot+=stake;
        if(r.quotaA){ oddSum+=r.quotaA; oddCount++; countA++; }
        if(r.quotaB){ oddSum+=r.quotaB; oddCount++; countB++; }

        const aWin=(r.esito==='Solo A vinta' || r.esito==='Vinte entrambe');
        const bWin=(r.esito==='Solo B vinta' || r.esito==='Vinte entrambe');
        if(aWin) winA++;
        if(bWin) winB++;
    });

    const totalBets = countA + countB;
    const winsBets  = winA + winB;
    const lostBets  = totalBets - winsBets;

    // KPI
    kpi_profit.textContent = (profit>=0?'+':'')+profit.toFixed(2)+'€';
    kpi_yield.textContent  = stakeTot>0?((profit/stakeTot)*100).toFixed(1)+'%':'-';
    kpi_odd.textContent    = oddCount>0?(oddSum/oddCount).toFixed(2):'-';
    kpi_stake.textContent  = matches>0?(stakeTot/matches).toFixed(2)+'€':'-';
    kpi_matches.textContent= matches;
    kpi_bets.textContent   = totalBets;
    kpi_wr_total.textContent = totalBets>0?((winsBets/totalBets)*100).toFixed(1)+'%':'-';
    kpi_wr_A.textContent     = countA>0?((winA/countA)*100).toFixed(1)+'%':'-';
    kpi_wr_B.textContent     = countB>0?((winB/countB)*100).toFixed(1)+'%':'-';

    // Win rate donut su bets
    const ctxW=chartWinRate.getContext('2d');
    const pWin  = totalBets>0?(winsBets/totalBets*100).toFixed(1):'0.0';
    const pLost = totalBets>0?(lostBets/totalBets*100).toFixed(1):'0.0';
    wr_win.textContent  = pWin+'%';
    wr_lost.textContent = pLost+'%';

    if(winChartObj) winChartObj.destroy();
    winChartObj=new Chart(ctxW,{
        type:'doughnut',
        data:{
            labels:['Won','Lost'],
            datasets:[{
                data:[winsBets,lostBets],
                backgroundColor:['#16a34a','#ef4444'],
                borderWidth:1
            }]
        },
        options:{
            cutout:'70%',
            plugins:{legend:{display:false}}
        }
    });

    // Profit chart cumulative
    const ctxP=chartProfit.getContext('2d');
    if(profitChartObj) profitChartObj.destroy();

    let labels=[], data=[];
    let cum=0;
    arr.sort((a,b)=>a.data>b.data?1:-1).forEach(r=>{
        cum+=r.profit;
        labels.push(r.data);
        data.push(cum);
    });
    if(!labels.length){ labels=[todayISO()]; data=[0]; }

    const finale=data[data.length-1];
    const lineColor=finale>=0?'#16a34a':'#ef4444';
    const areaColor=finale>=0?'rgba(22,163,74,0.25)':'rgba(239,68,68,0.25)';

    profitChartObj=new Chart(ctxP,{
        type:'line',
        data:{labels,datasets:[{
            data,
            borderColor:lineColor,
            backgroundColor:areaColor,
            tension:0.25,
            fill:true,
            pointRadius:0
        }]},
        options:{
            plugins:{legend:{display:false}},
            scales:{
                x:{grid:{display:false},ticks:{maxTicksLimit:6}},
                y:{grid:{color:'rgba(209,213,219,0.5)'}}
            }
        }
    });

    // Stake engine su TUTTO lo storico (all)
    const brStart = loadBankrollStart();
    const brInput = br_start;
    const brCurEl = br_current;
    const brDelEl = br_delta;
    const stkStdEl= stk_std;
    const stkHighEl=stk_high;
    const stkNoteEl=stk_note;

    if(brStart>0 && !brInput.value) brInput.value=brStart.toFixed(2);

    if(brStart<=0){
        brCurEl.textContent='-';
        brDelEl.textContent='-';
        stkStdEl.textContent='-';
        stkHighEl.textContent='-';
        stkNoteEl.textContent='Imposta un bankroll iniziale per avere lo stake consigliato.';
        return;
    }

    let totProfitAll=0, totStakeAll=0;
    all.forEach(r=>{
        totProfitAll+=r.profit;
        totStakeAll+= (r.stakeA+r.stakeB);
    });
    const brCurrent = brStart + totProfitAll;
    brCurEl.textContent = brCurrent.toFixed(2)+'€';
    const delta = brCurrent - brStart;
    brDelEl.textContent = (delta>=0?'+':'')+delta.toFixed(2)+'€';

    const STAKE_MIN = Math.max(1, brCurrent*0.02);
    const STAKE_BASE= brCurrent*0.05;
    const STAKE_MAX = brCurrent*0.10;
    const roiAll = totStakeAll>0? (totProfitAll/totStakeAll*100) : 0;

    let f=0.6;
    if(all.length===0) f=0.5;
    else{
        if(roiAll<=0) f=0.6;
        else if(roiAll<=2) f=0.7;
        else if(roiAll<=5) f=0.8;
        else if(roiAll<=10)f=0.9;
        else f=1.0;
    }

    let stakeStd = Math.min(Math.max(STAKE_BASE*f, STAKE_MIN), STAKE_MAX);
    let stakeHigh= Math.min(Math.max(STAKE_MAX*f, STAKE_MIN), STAKE_MAX);

    stkStdEl.textContent = stakeStd.toFixed(2)+'€';
    stkHighEl.textContent = stakeHigh.toFixed(2)+'€';

    stkNoteEl.textContent =
      `Stake base teorico (5% BR): ${STAKE_BASE.toFixed(2)}€. `+
      `Min: ${STAKE_MIN.toFixed(2)}€, Max: ${STAKE_MAX.toFixed(2)}€. `+
      `Fattore rischio f=${f.toFixed(2)} (basato su ROI e n° giocate).`;
}

/* ========= INIT ========= */
document.addEventListener('DOMContentLoaded',()=>{
    showTab('calc');
    renderStorico();
    aggiornaDashboard();

    const brStart = loadBankrollStart();
    if(brStart>0) br_start.value = brStart.toFixed(2);

    if('serviceWorker' in navigator){
        navigator.serviceWorker.register('service-worker.js').catch(()=>{});
    }
});
</script>

</body>
</html>
