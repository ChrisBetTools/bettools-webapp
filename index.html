<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<title>BetTools - Suite Calcolatori Betting</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
body {
    font-family: -apple-system, system-ui, sans-serif;
    margin: 0;
    padding: 0;
    background: #f5f6f7;
    color: #222;
}

.dark body {
    background: #121212;
    color: #e5e5e5;
}

/* Tabs */
.tabBar {
    display: flex;
    height: 48px;
    background: #e9eaed;
    border-bottom: 1px solid #ccc;
}
.tabBtn {
    flex: 1;
    text-align: center;
    line-height: 48px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    color: #666;
}
.tabBtn.active {
    color: #0a84ff;
    border-bottom: 3px solid #0a84ff;
    background: #fff;
}

/* Container */
.container {
    padding: 14px;
    max-width: 820px;
    margin: auto;
}

/* Input */
input, select {
    width: 100%;
    padding: 11px;
    font-size: 15px;
    border-radius: 8px;
    border: 1px solid #ccc;
    margin-top: 6px;
    background: white;
    color: black;
}

.dark input, .dark select {
    background: #1e1e1e;
    color: #fff;
    border-color: #444;
}

/* Buttons */
.btn {
    width: 100%;
    padding: 13px;
    font-size: 16px;
    font-weight: 600;
    background: #0a84ff;
    color: #fff;
    border-radius: 10px;
    border: none;
    margin-top: 14px;
    cursor: pointer;
}
.btn:active {
    opacity: 0.8;
}

/* Cards */
.card {
    background: #fff;
    padding: 14px;
    border-radius: 12px;
    margin-top: 16px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}
.dark .card {
    background: #1a1a1a;
    box-shadow: 0 0 0 transparent;
    border: 1px solid #333;
}

/* Storico */
.stRow {
    padding: 10px;
    border-bottom: 1px solid #ddd;
}
.dark .stRow {
    border-color: #333;
}
.stRow strong {
    font-size: 15px;
}

/* Grafico */
#equityChart {
    width: 100%;
    height: 260px;
}
</style>

</head>
<body>
<!-- ===== TABS SUPERIORI ===== -->
<div class="tabBar">
    <div class="tabBtn active" id="tab_calc" onclick="showTab('calc')">Calcolatori</div>
    <div class="tabBtn" id="tab_storico" onclick="showTab('storico')">Storico</div>
    <div class="tabBtn" id="tab_dash" onclick="showTab('dash')">Dashboard</div>
</div>

<!-- ===== CONTENUTO PRINCIPALE ===== -->
<div class="container">

<!-------------------------------------------
  TAB 1 - CALCOLATORI
-------------------------------------------->
<div id="page_calc">

    <!-- === ASIAN LINE INTERA === -->
    <div class="card">
        <h2>Asian Line Intera</h2>
        <p>Simula una linea asiatica intera usando due Over (es: Over 2.5 + Over 3.5 per simulare Over 3).</p>

        <label>Puntata Totale (€)</label>
        <input id="al_tot" type="number" step="0.1">

        <label>Quota A - Over Minore</label>
        <input id="al_qA" type="number" step="0.01">

        <label>Quota B - Over Maggiore</label>
        <input id="al_qB" type="number" step="0.01">

        <button class="btn" onclick="calcolaAsianIntera()">Calcola</button>

        <div id="al_out" class="card" style="margin-top:10px; display:none;"></div>

        <button class="btn" style="background:#636366" onclick="aggiungiStoricoDaCalc('asian')">
            + Aggiungi allo storico
        </button>
    </div>



    <!-- === PROTEZIONE (Giocata Principale + Secondaria) === -->
    <div class="card">
        <h2>Protezione Void (Principale + Secondaria)</h2>
        <p>Inserisci puntata totale e quote: calcola la distribuzione ideale per coprire la giocata A con B.</p>

        <label>Puntata Totale (€)</label>
        <input id="pv_tot" type="number" step="0.1">

        <label>Quota A (giocata principale)</label>
        <input id="pv_qA" type="number" step="0.01">

        <label>Quota B (copertura)</label>
        <input id="pv_qB" type="number" step="0.01">

        <button class="btn" onclick="calcolaProtezione()">Calcola</button>

        <div id="pv_out" class="card" style="margin-top:10px; display:none;"></div>

        <button class="btn" style="background:#636366" onclick="aggiungiStoricoDaCalc('protezione')">
            + Aggiungi allo storico
        </button>
    </div>

</div> <!-- fine tab calcolatori -->



<!-------------------------------------------
  TAB 2 - STORICO
-------------------------------------------->
<div id="page_storico" style="display:none;">

    <div class="card">
        <h2>Storico giocate</h2>

        <!-- FILTRI -->
        <label>Filtra per tipo</label>
        <select id="f_tipo" onchange="renderStorico(); aggiornaDashboard();">
            <option value="all">Tutto</option>
            <option value="asian">Asian Line</option>
            <option value="protezione">Protezione</option>
        </select>

        <label>Filtra per data</label>
        <input id="f_data" type="date" onchange="renderStorico(); aggiornaDashboard();">

        <div id="storicoList" style="margin-top:12px;"></div>

        <button class="btn" style="background:#ff3b30" onclick="resetStorico()">
            Reset Storico
        </button>

        <button class="btn" style="background:#34c759; margin-top:10px;" onclick="exportCSV()">
            Esporta CSV
        </button>
    </div>

</div> <!-- fine storico -->



<!-------------------------------------------
  TAB 3 - DASHBOARD
-------------------------------------------->
<div id="page_dash" style="display:none;">

    <div class="card">
        <h2>Andamento & KPI</h2>

        <canvas id="equityChart" width="600" height="260"></canvas>
    </div>

    <div class="card">
        <h3>Statistiche</h3>

        <p><strong>Profitto totale:</strong> <span id="d_profit">-</span></p>
        <p><strong>ROI:</strong> <span id="d_roi">-</span></p>
        <p><strong>N° giocate:</strong> <span id="d_count">-</span></p>
        <p><strong>Quota media:</strong> <span id="d_quotaMedia">-</span></p>
        <p><strong>Winrate (A - B):</strong> <span id="d_ab">-</span></p>
        <p><strong>Winrate principale:</strong> <span id="d_winrate">-</span></p>
    </div>

    <div class="card">
        <h3>Stake suggerito (basato su bankroll)</h3>

        <label>Bankroll iniziale (€)</label>
        <input id="br_start" type="number" step="0.1" oninput="saveBankrollStart(); aggiornaDashboard();">

        <p><strong>Bankroll attuale:</strong> <span id="br_current">-</span></p>
        <p id="br_delta" style="margin-bottom:10px;">-</p>

        <p><strong>Stake Standard (5% BR):</strong> <span id="stk_std">-</span></p>
        <p><strong>Stake High-Edge (10% BR):</strong> <span id="stk_high">-</span></p>

        <p id="stk_note" style="font-size:13px; opacity:0.8; margin-top:8px;"></p>
    </div>

</div> <!-- fine dashboard -->

</div> <!-- fine container -->


<!-------------------------------------------
  POPUP MODIFICA STORICO
-------------------------------------------->
<div id="editModal"
     style="
       position:fixed; left:0; top:0; width:100%; height:100%;
       background:rgba(0,0,0,0.55); display:none;
       justify-content:center; align-items:center; z-index:999;"
>
    <div class="card" style="max-width:420px; width:90%;">

        <h3>Modifica giocata</h3>

        <input type="hidden" id="em_id">

        <label>Tipo</label>
        <select id="em_tipo">
            <option value="asian">Asian Line</option>
            <option value="protezione">Protezione</option>
        </select>

        <label>Data</label>
        <input id="em_data" type="date">

        <label>Partita</label>
        <input id="em_partita" type="text">

        <label>Quota A</label>
        <input id="em_qA" type="number" step="0.01">

        <label>Quota B</label>
        <input id="em_qB" type="number" step="0.01">

        <label>Stake A</label>
        <input id="em_sA" type="number" step="0.01">

        <label>Stake B</label>
        <input id="em_sB" type="number" step="0.01">

        <label>Esito</label>
        <select id="em_esito">
            <option value="Vinte entrambe">Vinte entrambe</option>
            <option value="Solo A vinta">Solo A vinta</option>
            <option value="Solo B vinta">Solo B vinta</option>
            <option value="Perse entrambe">Perse entrambe</option>
            <option value="Non giocata">Non giocata</option>
        </select>

        <button class="btn" onclick="saveEdit()">Salva</button>
        <button class="btn" style="background:#ccc; color:#333;" onclick="closeEdit()">Chiudi</button>

    </div>
</div>

<script>
/* ==========================================
   COSTANTI & UTILITY
========================================== */
const LS_KEY = 'bettools_history';
const LS_BANKROLL = 'bettools_bankroll_start';

function safeNum(v) {
    const n = parseFloat(v);
    return isNaN(n) ? 0 : n;
}

// Arrotonda allo 0.1 più vicino
function roundBook(x) {
    return Math.round(x * 10) / 10;
}

function todayISO() {
    const d = new Date();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${d.getFullYear()}-${m}-${day}`;
}

/* ==========================================
   STORAGE STORICO
========================================== */

function loadStorico() {
    try {
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr)) return [];
        return arr;
    } catch (e) {
        return [];
    }
}

function saveStorico(arr) {
    localStorage.setItem(LS_KEY, JSON.stringify(arr));
}

function resetStorico() {
    if (!confirm("Sei sicuro di voler cancellare tutto lo storico?")) return;
    localStorage.removeItem(LS_KEY);
    renderStorico();
    aggiornaDashboard();
}

/* ==========================================
   STORAGE BANKROLL
========================================== */

function loadBankrollStart() {
    const raw = localStorage.getItem(LS_BANKROLL);
    const v = safeNum(raw);
    return v > 0 ? v : 0;
}

function saveBankrollStart() {
    const v = safeNum(document.getElementById('br_start').value);
    if (v > 0) {
        localStorage.setItem(LS_BANKROLL, v.toString());
    } else {
        localStorage.removeItem(LS_BANKROLL);
    }
}

/* ==========================================
   TABS
========================================== */
function showTab(name) {
    const tabs = ['calc', 'storico', 'dash'];

    tabs.forEach(t => {
        document.getElementById('page_' + t).style.display = (t === name) ? '' : 'none';
    });

    document.getElementById('tab_calc').classList.remove('active');
    document.getElementById('tab_storico').classList.remove('active');
    document.getElementById('tab_dash').classList.remove('active');

    if (name === 'calc') document.getElementById('tab_calc').classList.add('active');
    if (name === 'storico') document.getElementById('tab_storico').classList.add('active');
    if (name === 'dash') document.getElementById('tab_dash').classList.add('active');

    if (name === 'storico' || name === 'dash') {
        renderStorico();
        aggiornaDashboard();
    }
}

/* ==========================================
   CALCOLATORI
========================================== */

let lastCalc = null; // usato da aggiungiStoricoDaCalc

// 1) Asian Line Intera
function calcolaAsianIntera() {
    const S = safeNum(document.getElementById('al_tot').value);
    const qA = safeNum(document.getElementById('al_qA').value);
    const qB = safeNum(document.getElementById('al_qB').value);
    const out = document.getElementById('al_out');

    if (S <= 0 || qA <= 1 || qB <= 1) {
        out.style.display = 'block';
        out.innerHTML = '<span style="color:#ff3b30;">Inserisci puntata e quote valide (&gt;1.00).</span>';
        return;
    }

    // StakeA circa S / qA (in modo che sulla linea "void" il risultato sia circa 0)
    let stakeA = S / qA;
    let stakeB = S - stakeA;

    stakeA = roundBook(stakeA);
    stakeB = roundBook(stakeB);
    const stakeTot = stakeA + stakeB;

    // Profitti
    const ritornoVoid = stakeA * qA;        // Over minore vinto, Over maggiore perso
    const profitVoid = ritornoVoid - stakeTot;

    const ritornoBoth = stakeA * qA + stakeB * qB; // entrambi vincenti
    const profitBoth = ritornoBoth - stakeTot;

    out.style.display = 'block';
    out.innerHTML =
        `<p><strong>Punta su Over Minore:</strong> ${stakeA.toFixed(1)}€ @ ${qA.toFixed(2)}<br>` +
        `<strong>Punta su Over Maggiore:</strong> ${stakeB.toFixed(1)}€ @ ${qB.toFixed(2)}</p>` +
        `<p><strong>Entrambe Vinte:</strong> ${(profitBoth >= 0 ? '+' : '') + profitBoth.toFixed(2)}€</p>` +
        `<p><strong>Solo Over Minore vinto:</strong> ${(profitVoid >= 0 ? '+' : '') + profitVoid.toFixed(2)}€</p>`;

    lastCalc = {
        tipo: 'asian',
        quotaA: qA,
        quotaB: qB,
        stakeA,
        stakeB
    };
}

// 2) Protezione (Principale + Secondaria)
function calcolaProtezione() {
    const S = safeNum(document.getElementById('pv_tot').value);
    const qA = safeNum(document.getElementById('pv_qA').value);
    const qB = safeNum(document.getElementById('pv_qB').value);
    const out = document.getElementById('pv_out');

    if (S <= 0 || qA <= 1 || qB <= 1) {
        out.style.display = 'block';
        out.innerHTML = '<span style="color:#ff3b30;">Inserisci puntata e quote valide (&gt;1.00).</span>';
        return;
    }

    // Obiettivo: se A perde ma B vince → quasi void
    // stakeB * (qB - 1) ≈ S  → stakeB ≈ S / (qB - 1), ma non > S
    let stakeB = S / (qB - 1);
    if (stakeB > S) stakeB = S;
    let stakeA = S - stakeB;

    stakeA = roundBook(stakeA);
    stakeB = roundBook(stakeB);
    const stakeTot = stakeA + stakeB;

    const profitSoloA = (stakeA * qA) - stakeTot;
    const profitSoloB = (stakeB * qB) - stakeTot;
    const profitEntrambe = (stakeA * qA + stakeB * qB) - stakeTot;

    out.style.display = 'block';
    out.innerHTML =
        `<p><strong>Punta su A (principale):</strong> ${stakeA.toFixed(1)}€ @ ${qA.toFixed(2)}<br>` +
        `<strong>Punta su B (copertura):</strong> ${stakeB.toFixed(1)}€ @ ${qB.toFixed(2)}</p>` +
        `<p><strong>Solo A vinta:</strong> ${(profitSoloA >= 0 ? '+' : '') + profitSoloA.toFixed(2)}€</p>` +
        `<p><strong>Solo B vinta:</strong> ${(profitSoloB >= 0 ? '+' : '') + profitSoloB.toFixed(2)}€ (quasi void)</p>` +
        `<p><strong>Entrambe Vinte:</strong> ${(profitEntrambe >= 0 ? '+' : '') + profitEntrambe.toFixed(2)}€</p>`;

    lastCalc = {
        tipo: 'protezione',
        quotaA: qA,
        quotaB: qB,
        stakeA,
        stakeB
    };
}

/* ==========================================
   AGGIUNTA ALLO STORICO DAL CALCOLATORE
========================================== */

function aggiungiStoricoDaCalc(tipo) {
    if (!lastCalc || lastCalc.tipo !== tipo) {
        alert("Prima effettua un calcolo per questo tipo.");
        return;
    }
    const partita = prompt("Inserisci nome partita (es: Inter - Milan):", "");
    const partitaClean = partita ? partita.trim() : "";

    const arr = loadStorico();
    const newId = arr.length ? (Math.max(...arr.map(r => r.id || 0)) + 1) : 1;

    const rec = {
        id: newId,
        tipo: tipo,
        data: todayISO(),
        partita: partitaClean,
        quotaA: lastCalc.quotaA,
        quotaB: lastCalc.quotaB,
        stakeA: lastCalc.stakeA,
        stakeB: lastCalc.stakeB,
        esito: 'Non giocata',
        profit: 0
    };

    arr.push(rec);
    saveStorico(arr);
    renderStorico();
    aggiornaDashboard();
    alert("Giocata aggiunta allo storico con esito 'Non giocata'.");
}

/* ==========================================
   FILTRI STORICO PER DASH E LISTA
========================================== */
function getFilteredHistory() {
    const arr = loadStorico();
    const tipo = document.getElementById('f_tipo').value;
    const d = document.getElementById('f_data').value;

    return arr.filter(r => {
        if (tipo !== 'all' && r.tipo !== tipo) return false;
        if (d && r.data < d) return false;
        return true;
    });
}

/* ==========================================
   RENDER STORICO LISTA
========================================== */
function renderStorico() {
    const list = document.getElementById('storicoList');
    if (!list) return;
    const arr = getFilteredHistory();

    // ordina per data desc + id desc
    arr.sort((a, b) => {
        if (a.data === b.data) return (b.id || 0) - (a.id || 0);
        return (a.data > b.data) ? -1 : 1;
    });

    if (!arr.length) {
        list.innerHTML = '<p style="opacity:0.7;">Nessuna giocata registrata per i filtri selezionati.</p>';
        return;
    }

    let html = '';
    arr.forEach(r => {
        const profitStr = (r.profit >= 0 ? '+' : '') + r.profit.toFixed(2) + '€';
        html += `
        <div class="stRow">
            <strong>${r.data} – ${r.partita || '(nessuna partita)'}</strong><br>
            <span style="font-size:13px; opacity:0.8;">
                Tipo: ${r.tipo} – QuotaA ${r.quotaA.toFixed(2)}${r.quotaB ? ' / QuotaB ' + r.quotaB.toFixed(2) : ''}
            </span><br>
            <span style="font-size:13px;">
                Stake A: ${r.stakeA.toFixed(2)}€ · Stake B: ${r.stakeB.toFixed(2)}€
            </span><br>
            <span style="font-size:13px;">
                Esito: ${r.esito} – Profitto: ${profitStr}
            </span><br>
            <button class="btn" style="margin-top:6px; background:#8e8e93;" onclick="openEdit(${r.id})">
                Modifica
            </button>
        </div>`;
    });

    list.innerHTML = html;
}

/* ==========================================
   MODALE EDIT STORICO
========================================== */

function openEdit(id) {
    const arr = loadStorico();
    const rec = arr.find(r => r.id === id);
    if (!rec) return;

    document.getElementById('em_id').value = rec.id;
    document.getElementById('em_tipo').value = rec.tipo;
    document.getElementById('em_data').value = rec.data;
    document.getElementById('em_partita').value = rec.partita || '';
    document.getElementById('em_qA').value = rec.quotaA.toFixed(2);
    document.getElementById('em_qB').value = rec.quotaB ? rec.quotaB.toFixed(2) : '';
    document.getElementById('em_sA').value = rec.stakeA.toFixed(2);
    document.getElementById('em_sB').value = rec.stakeB.toFixed(2);
    document.getElementById('em_esito').value = rec.esito;

    document.getElementById('editModal').style.display = 'flex';
}

function closeEdit() {
    document.getElementById('editModal').style.display = 'none';
}

function saveEdit() {
    const id = parseInt(document.getElementById('em_id').value, 10);
    const arr = loadStorico();
    const idx = arr.findIndex(r => r.id === id);
    if (idx === -1) return;

    const tipo = document.getElementById('em_tipo').value;
    const data = document.getElementById('em_data').value || todayISO();
    const partita = document.getElementById('em_partita').value || '';
    const qA = safeNum(document.getElementById('em_qA').value);
    const qB = safeNum(document.getElementById('em_qB').value);
    const sA = safeNum(document.getElementById('em_sA').value);
    const sB = safeNum(document.getElementById('em_sB').value);
    const esito = document.getElementById('em_esito').value;

    let profit = 0;
    const stakeTot = sA + sB;

    switch (esito) {
        case 'Vinte entrambe':
            profit = (sA * qA + sB * qB) - stakeTot;
            break;
        case 'Solo A vinta':
            profit = (sA * qA) - stakeTot;
            break;
        case 'Solo B vinta':
            profit = (sB * qB) - stakeTot;
            break;
        case 'Perse entrambe':
            profit = -stakeTot;
            break;
        case 'Non giocata':
        default:
            profit = 0;
    }

    arr[idx] = {
        id,
        tipo,
        data,
        partita,
        quotaA: qA,
        quotaB: qB || 0,
        stakeA: sA,
        stakeB: sB,
        esito,
        profit
    };

    saveStorico(arr);
    closeEdit();
    renderStorico();
    aggiornaDashboard();
}

/* ==========================================
   DASHBOARD + GRAFICO
========================================== */

function aggiornaDashboard() {
    const arrAll = loadStorico();
    const arr = getFilteredHistory();

    let totProfit = 0, totStake = 0;
    let quotaMediaSum = 0, quotaMediaCount = 0;
    let countAll = arr.length;
    let winA = 0, winB = 0, winAny = 0;

    arr.forEach(r => {
        totProfit += r.profit;
        const st = r.stakeA + r.stakeB;
        totStake += st;
        const qMed = r.quotaB ? (r.quotaA + r.quotaB) / 2 : r.quotaA;
        quotaMediaSum += qMed;
        quotaMediaCount++;

        const aWin = (r.esito === 'Vinte entrambe' || r.esito === 'Solo A vinta');
        const bWin = (r.esito === 'Vinte entrambe' || r.esito === 'Solo B vinta');

        if (aWin) winA++;
        if (bWin) winB++;
        if (aWin || bWin) winAny++;
    });

    const d_profit = document.getElementById('d_profit');
    const d_roi = document.getElementById('d_roi');
    const d_count = document.getElementById('d_count');
    const d_quotaMedia = document.getElementById('d_quotaMedia');
    const d_winrate = document.getElementById('d_winrate');
    const d_ab = document.getElementById('d_ab');

    d_profit.textContent = (totProfit >= 0 ? '+' : '') + totProfit.toFixed(2) + '€';

    const roi = totStake > 0 ? (totProfit / totStake) * 100 : 0;
    d_roi.textContent = totStake > 0 ? roi.toFixed(2) + '%' : '-';

    d_count.textContent = countAll;
    d_quotaMedia.textContent = quotaMediaCount > 0 ? (quotaMediaSum / quotaMediaCount).toFixed(2) : '-';

    const wrA = countAll > 0 ? (winA / countAll) * 100 : 0;
    const wrB = countAll > 0 ? (winB / countAll) * 100 : 0;
    const wrAny = countAll > 0 ? (winAny / countAll) * 100 : 0;

    d_ab.textContent = countAll > 0
        ? `A: ${wrA.toFixed(1)}% · B: ${wrB.toFixed(1)}%`
        : '-';

    d_winrate.textContent = countAll > 0 ? wrAny.toFixed(1) + '%' : '-';

    // equity chart
    renderEquityChart(arr);

    // ===== BANKROLL & STAKE =====
    const brStart = loadBankrollStart();
    const brStartInput = document.getElementById('br_start');
    const brCurrentEl = document.getElementById('br_current');
    const brDeltaEl = document.getElementById('br_delta');
    const stkStdEl = document.getElementById('stk_std');
    const stkHighEl = document.getElementById('stk_high');
    const stkNoteEl = document.getElementById('stk_note');

    if (brStart > 0 && !brStartInput.value) {
        brStartInput.value = brStart.toFixed(2);
    }

    if (brStart <= 0) {
        brCurrentEl.textContent = '-';
        brDeltaEl.textContent = 'Imposta un bankroll iniziale per ottenere uno stake suggerito.';
        stkStdEl.textContent = '-';
        stkHighEl.textContent = '-';
        stkNoteEl.textContent = '';
        return;
    }

    // bankroll attuale = iniziale + profitto TOTALE su tutto lo storico
    let totProfitAll = 0;
    arrAll.forEach(r => totProfitAll += r.profit);
    const brCurrent = brStart + totProfitAll;
    brCurrentEl.textContent = brCurrent.toFixed(2) + '€';

    const delta = brCurrent - brStart;
    brDeltaEl.textContent = 'Δ vs iniziale: ' + (delta >= 0 ? '+' : '') + delta.toFixed(2) + '€';

    // stake boundaries
    const STAKE_MIN = Math.max(1, brCurrent * 0.02);
    const STAKE_BASE = brCurrent * 0.05;
    const STAKE_MAX = brCurrent * 0.10;

    let f = 0.6; // fattore rischio base
    if (countAll === 0) {
        f = 0.5;
    } else {
        if (roi <= 0) f = 0.6;
        else if (roi <= 2) f = 0.7;
        else if (roi <= 5) f = 0.8;
        else if (roi <= 10) f = 0.9;
        else f = 1.0;
    }

    let stakeStd = STAKE_BASE * f;
    let stakeHigh = STAKE_MAX * f;

    if (stakeStd < STAKE_MIN) stakeStd = STAKE_MIN;
    if (stakeStd > STAKE_MAX) stakeStd = STAKE_MAX;

    if (stakeHigh < STAKE_MIN) stakeHigh = STAKE_MIN;
    if (stakeHigh > STAKE_MAX) stakeHigh = STAKE_MAX;

    stakeStd = roundBook(stakeStd);
    stakeHigh = roundBook(stakeHigh);

    stkStdEl.textContent = stakeStd.toFixed(2) + '€';
    stkHighEl.textContent = stakeHigh.toFixed(2) + '€';

    stkNoteEl.textContent =
        `Stake base (5% BR): ${STAKE_BASE.toFixed(2)}€. ` +
        `Min: ${roundBook(STAKE_MIN).toFixed(2)}€, Max: ${STAKE_MAX.toFixed(2)}€. ` +
        `Fattore rischio f = ${f.toFixed(2)} (basato su ROI & n° giocate).`;
}

/* ==========================================
   EQUITY CHART (CANVAS)
========================================== */
function renderEquityChart(arr) {
    const canvas = document.getElementById('equityChart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');

    ctx.clearRect(0,0,canvas.width,canvas.height);

    // ordiniamo per data crescente
    const entries = arr.slice().sort((a,b) => {
        if (a.data === b.data) return (a.id||0) - (b.id||0);
        return a.data < b.data ? -1 : 1;
    });

    if (!entries.length) {
        ctx.fillStyle = '#9ca3af';
        ctx.font = '13px -apple-system, system-ui, sans-serif';
        ctx.fillText('Nessuna giocata per il filtro selezionato.', 10, canvas.height/2);
        return;
    }

    let cum = 0;
    const points = [];
    entries.forEach((r, idx) => {
        cum += r.profit;
        points.push({ x: idx, y: cum });
    });

    const ys = points.map(p => p.y);
    const minY = Math.min(...ys);
    const maxY = Math.max(...ys);
    const padX = 24, padY = 16;
    const w = canvas.width - padX*2;
    const h = canvas.height - padY*2;

    function mapX(i) {
        if (points.length === 1) return padX + w/2;
        return padX + (i / (points.length - 1)) * w;
    }
    function mapY(val) {
        if (maxY === minY) return padY + h/2;
        return padY + h - ((val - minY) / (maxY - minY)) * h;
    }

    // linea zero se attraversa lo 0
    const zeroY = (minY <= 0 && maxY >= 0) ? mapY(0) : null;
    if (zeroY !== null) {
        ctx.strokeStyle = '#d1d5db';
        ctx.lineWidth = 1;
        ctx.setLineDash([4,3]);
        ctx.beginPath();
        ctx.moveTo(padX, zeroY);
        ctx.lineTo(padX + w, zeroY);
        ctx.stroke();
        ctx.setLineDash([]);
    }

    const finale = points[points.length - 1].y;
    const areaColor = finale >= 0 ? 'rgba(16,185,129,0.20)' : 'rgba(248,113,113,0.25)';
    const lineColor = finale >= 0 ? '#10b981' : '#ef4444';

    // area
    ctx.beginPath();
    points.forEach((p, i) => {
        const x = mapX(i);
        const y = mapY(p.y);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    });
    // chiudi verso basso
    const lastX = mapX(points.length - 1);
    const firstX = mapX(0);
    ctx.lineTo(lastX, padY + h);
    ctx.lineTo(firstX, padY + h);
    ctx.closePath();
    ctx.fillStyle = areaColor;
    ctx.fill();

    // linea
    ctx.beginPath();
    points.forEach((p, i) => {
        const x = mapX(i);
        const y = mapY(p.y);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    });
    ctx.strokeStyle = lineColor;
    ctx.lineWidth = 2;
    ctx.stroke();
}

/* ==========================================
   EXPORT CSV
========================================== */
function exportCSV() {
    const arr = loadStorico().sort((a,b) => {
        if (a.data === b.data) return (a.id||0) - (b.id||0);
        return a.data < b.data ? -1 : 1;
    });

    if (!arr.length) {
        alert('Nessuna riga da esportare.');
        return;
    }

    const header = ['Data','Tipo','Partita','QuotaA','QuotaB','StakeA','StakeB','Esito','Profitto'];
    const rows = [header.join(';')];

    arr.forEach(r => {
        rows.push([
            r.data,
            r.tipo,
            (r.partita || '').replace(/;/g, ','),
            r.quotaA.toFixed(2),
            r.quotaB ? r.quotaB.toFixed(2) : '0.00',
            r.stakeA.toFixed(2),
            r.stakeB.toFixed(2),
            r.esito,
            r.profit.toFixed(2)
        ].join(';'));
    });

    const blob = new Blob([rows.join('\n')], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'bettools_storico.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

/* ==========================================
   INIT
========================================== */
document.addEventListener('DOMContentLoaded', () => {
    showTab('calc');
    renderStorico();
    aggiornaDashboard();

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('service-worker.js').catch(()=>{});
    }
});
</script>
</body>
</html>
