<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BetTools</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0a84ff">

<style>
body {
    margin: 0;
    font-family: -apple-system, system-ui, sans-serif;
    background: #f5f5f7;
    color: #111;
}

/* ====== DARK MODE FIX ====== */
@media (prefers-color-scheme: dark) {
    body { background: #000; color: #fff; }
    input, select { background: #222 !important; color: #fff !important; }
}

/* ====== Hamburger ====== */
#hamburgerBar {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: #0a84ff;
    color: #fff;
    font-size: 20px;
}
#hamburgerBar #hamBtn { font-size: 26px; cursor: pointer; }

/* ===== Sidebar ===== */
#sideMenu {
    position: fixed;
    top: 0; left: -260px;
    width: 260px;
    height: 100vh;
    background: #111;
    color: #fff;
    padding: 20px;
    transition: left .25s ease;
    z-index: 9999;
}

#sideMenu a {
    display: block;
    padding: 12px 0;
    font-size: 18px;
    border-bottom: 1px solid #333;
    color: #fff;
    text-decoration: none;
}

#sideMenu a:hover { color: #0a84ff; }

/* ==== containers ==== */
.container {
    padding: 18px;
}

.card {
    background: #fff;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 20px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.12);
}
@media (prefers-color-scheme: dark) {
    .card { background: #1c1c1e; }
}

/* Dashboard chart sizing */
#winRateChart {
    max-width: 280px;
    margin: 0 auto 18px auto;
}
#equityChart {
    width: 100%;
    height: 240px;
}

/* Hidden tabs (replaced by menu) */
.tab-container { display: none; }

/* Inputs */
input, select {
    width: 100%;
    padding: 10px;
    margin-top: 6px;
    margin-bottom: 12px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 16px;
}
button {
    width: 100%;
    padding: 12px;
    background: #0a84ff;
    color: #fff;
    border: none;
    font-size: 18px;
    border-radius: 10px;
    cursor: pointer;
}
button:hover { opacity: 0.9; }

.resultBox {
    padding: 12px;
    margin-top: 12px;
    background: #e9eefc;
    border-radius: 8px;
    font-size: 17px;
}
@media (prefers-color-scheme: dark) {
    .resultBox { background: #141a2c; }
}

/* Storico */
.stRow {
    padding: 12px;
    border-bottom: 1px solid #ccc;
}
.esitoPending { color: #ff4444; font-weight: 600; }
.esitoDone { color: #0a84ff; }

/* Asian Live outcome colors */
.pos { color: #00b300; }
.neg { color: #ff3333; }
.half { color: #ff9900; }

</style>
</head>
<body>

<!-- ========== HAMBURGER BAR ========== -->
<div id="hamburgerBar">
    <span id="hamBtn">☰</span>
    <strong>BetTools</strong>
</div>

<!-- ========== SIDEBAR MENU ========== -->
<div id="sideMenu">
    <a href="#" onclick="openTab('calc')">Calcolatori</a>
    <a href="#" onclick="openTab('storico')">Storico</a>
    <a href="#" onclick="openTab('dash')">Dashboard</a>
    <a href="#" onclick="openTab('daily')">Riepilogo Giornaliero</a>
    <a href="#" onclick="closeMenu()">Chiudi</a>
</div>

<!-- ========== MAIN AREA ========== -->
<div id="mainContent" class="container">

<!-- ==========================
     TAB CALCOLATORI
========================== -->
<div id="tab_calc">

    <!-- ==== CALCOLATORE ASIAN INTERA ==== -->
    <div class="card">
        <h2>Asian Line Intera</h2>

        <label>Stake Totale</label>
        <input id="ai_stake" type="number" step="0.1">

        <label>Quota Under</label>
        <input id="ai_qUnder" type="number" step="0.01">

        <label>Quota Over</label>
        <input id="ai_qOver" type="number" step="0.01">

        <button onclick="calcolaAsianIntera()">Calcola</button>

        <div id="ai_res" class="resultBox" style="display:none"></div>
    </div>

    <!-- ==== CALCOLATORE PROTEZIONE ==== -->
    <div class="card">
        <h2>Protezione</h2>

        <label>Stake Totale</label>
        <input id="pr_stake" type="number" step="0.1">

        <label>Quota A</label>
        <input id="pr_qA" type="number" step="0.01">

        <label>Quota B</label>
        <input id="pr_qB" type="number" step="0.01">

        <button onclick="calcolaProtezione()">Calcola</button>

        <div id="pr_res" class="resultBox" style="display:none"></div>
    </div>

    <!-- ==== CALCOLATORE ASIAN OVER LIVE ==== -->
    <div class="card">
        <h2>Asian Over Live</h2>

        <label>Goal già segnati</label>
        <input id="al_g" type="number">

        <label>Linea asiatica (es. 1.75)</label>
        <input id="al_line" type="number" step="0.25">

        <label>Stake Totale</label>
        <input id="al_stake" type="number" step="0.1">

        <label>Quota A (linea bassa)</label>
        <input id="al_qA" type="number" step="0.01">

        <label>Quota B (linea alta)</label>
        <input id="al_qB" type="number" step="0.01">

        <button onclick="calcolaAsianLive()">Calcola</button>

        <div id="al_res" class="resultBox" style="display:none"></div>
    </div>

    <!-- ====== GOALOO / SOCCERSTATS ====== -->
    <div class="card">
        <h3>Ricerca Partita</h3>

        <label>Home Team</label>
        <input id="t_home">

        <label>Away Team</label>
        <input id="t_away">

        <label>Data (AAAA-MM-GG)</label>
        <input id="t_date" type="date">

        <button onclick="openGoaloo()">Apri su Goaloo</button>
        <button onclick="openSoccerstats()">Apri su SoccerStats</button>
    </div>

</div> <!-- Fine tab_calc -->

<!-- =====================================
     TAB STORICO
===================================== -->
<div id="tab_storico" style="display:none">

    <div class="card">
        <h2>Aggiungi allo storico</h2>

        <label>Data</label>
        <input id="st_data" type="date">

        <label>Tipo Scommessa</label>
        <select id="st_tipo">
            <option value="">Seleziona...</option>
            <option>Asian Line Intera</option>
            <option>Protezione</option>
            <option>Asian Over Live</option>
            <option>2 More Corner FT</option>
            <option>Next Goal Home - Pari</option>
            <option>New Neigh Casa</option>
            <option>New Dominio Home</option>
            <option>Secondo Goal HT Lite</option>
        </select>

        <label>Partita</label>
        <input id="st_partita" placeholder="Es. Inter - Liverpool">

        <label>Quota A</label>
        <input id="st_qA" type="number" step="0.01">

        <label>Quota B</label>
        <input id="st_qB" type="number" step="0.01">

        <label>Stake A</label>
        <input id="st_sA" type="number" step="0.1">

        <label>Stake B</label>
        <input id="st_sB" type="number" step="0.1">

        <label>Esito</label>
        <select id="st_esito">
            <option>Non giocata</option>
            <option>Vinte entrambe</option>
            <option>Perse entrambe</option>
            <option>Solo A vinta</option>
            <option>Solo B vinta</option>
        </select>

        <button onclick="addStorico()">Aggiungi</button>
    </div>

    <div id="storicoList"></div>

</div>

<!-- =====================================
     TAB DASHBOARD
===================================== -->
<div id="tab_dash" style="display:none">
    <div class="card">
        <h2>Dashboard</h2>

        <canvas id="winRateChart"></canvas>

        <p><strong>Totale Bet:</strong> <span id="d_bet"></span></p>
        <p><strong>Win totale:</strong> <span id="d_win"></span></p>
        <p><strong>Win %:</strong> <span id="d_winp"></span></p>

        <p><strong>Quota A win %:</strong> <span id="d_wA"></span></p>
        <p><strong>Quota B win %:</strong> <span id="d_wB"></span></p>

        <p><strong>Profitto:</strong> <span id="d_profit"></span></p>

        <h3>Equity</h3>
        <canvas id="equityChart"></canvas>
    </div>
</div>

<!-- =====================================
     TAB RIEPILOGO GIORNALIERO
===================================== -->
<div id="tab_daily" style="display:none">
    <div class="card">
        <h2>Riepilogo Giornaliero</h2>

        <p><strong>Profitto del giorno:</strong> <span id="dy_profit"></span></p>
        <p><strong>Bet giocate oggi:</strong> <span id="dy_bet"></span></p>
        <p><strong>Win % oggi:</strong> <span id="dy_wp"></span></p>
        <p><strong>Stato:</strong> <span id="dy_state"></span></p>

    </div>
</div>

</div><!-- end main content -->
<script>
// ===============================
// MENU HAMBURGER
// ===============================
const sideMenu = document.getElementById("sideMenu");
const hamBtn = document.getElementById("hamBtn");

hamBtn.onclick = () => {
    sideMenu.style.left = "0px";
};
function closeMenu() {
    sideMenu.style.left = "-260px";
}

function openTab(tab) {
    closeMenu();
    document.getElementById("tab_calc").style.display = "none";
    document.getElementById("tab_storico").style.display = "none";
    document.getElementById("tab_dash").style.display = "none";
    document.getElementById("tab_daily").style.display = "none";

    document.getElementById("tab_"+tab).style.display = "block";
}



// ===============================
// ROUND PER BOOKMAKER (UNA CIFRA)
// ===============================
function roundBook(x) {
    return Math.round(x * 10) / 10;
}



// ===============================
// FUNZIONE CENTRALE:
// Stake minimo 1€ per tutti i calcolatori
// ===============================
function adjustStakeMin(stA, stB, total) {

    // Caso semplice: stake totali sotto 2€
    if (total < 2) {
        return {
            a: roundBook(total),
            b: 0,
            note: "Stake totale troppo basso per due puntate. Tutto su A."
        };
    }

    let A = stA;
    let B = stB;

    // Se entrambi ≥1 → ok
    if (A >= 1 && B >= 1) {
        return { a: roundBook(A), b: roundBook(B), note: "" };
    }

    // Se uno dei due è <1 → portalo a 1 e correggi l’altro
    if (A < 1) {
        A = 1;
        B = total - 1;
    }
    if (B < 1) {
        B = 1;
        A = total - 1;
    }

    // Se ancora il correttivo crea problemi (B <0), fallback
    if (A < 0) A = 0;
    if (B < 0) B = 0;

    return {
        a: roundBook(A),
        b: roundBook(B),
        note: ""
    };
}



// ============================================
// CALCOLATORE 1 — ASIAN INTERA
// ============================================
function calcolaAsianIntera() {
    const stake = parseFloat(document.getElementById("ai_stake").value);
    const qU = parseFloat(document.getElementById("ai_qUnder").value);
    const qO = parseFloat(document.getElementById("ai_qOver").value);

    if (!stake || !qU || !qO) return;

    // Formula base: split proporzionale
    let stA = stake * (qO / (qU + qO));
    let stB = stake - stA;

    // Correggi stake minimi
    const fixed = adjustStakeMin(stA, stB, stake);

    // Mostra risultato
    const box = document.getElementById("ai_res");
    box.style.display = "block";
    box.innerHTML = `
        Stake Under: <b>${fixed.a}</b><br>
        Stake Over: <b>${fixed.b}</b><br>
        ${fixed.note ? "<br><i>"+fixed.note+"</i>" : ""}
    `;
}



// ============================================
// CALCOLATORE 2 — PROTEZIONE
// ============================================
function calcolaProtezione() {
    const stake = parseFloat(document.getElementById("pr_stake").value);
    const qA = parseFloat(document.getElementById("pr_qA").value);
    const qB = parseFloat(document.getElementById("pr_qB").value);

    if (!stake || !qA || !qB) return;

    // Formula base:
    let stA = stake * (qB / (qA + qB));
    let stB = stake - stA;

    // Correggi stake minimi
    const fixed = adjustStakeMin(stA, stB, stake);

    const box = document.getElementById("pr_res");
    box.style.display = "block";
    box.innerHTML = `
        Stake A: <b>${fixed.a}</b><br>
        Stake B: <b>${fixed.b}</b><br>
        ${fixed.note ? "<br><i>"+fixed.note+"</i>" : ""}
    `;
}



// ============================================
// CALCOLATORE 3 — ASIAN OVER LIVE
// Logica completamente asiatica
// ============================================
function calcolaAsianLive() {

    const g = parseInt(document.getElementById("al_g").value);
    const line = parseFloat(document.getElementById("al_line").value);
    const stake = parseFloat(document.getElementById("al_stake").value);
    const qA = parseFloat(document.getElementById("al_qA").value);
    const qB = parseFloat(document.getElementById("al_qB").value);

    if (isNaN(g) || !line || !stake || !qA || !qB) return;

    // LINEA → identifica parte bassa e parte alta
    const base = Math.floor(line);
    const frac = line - base; // .25 o .75

    let stA = stake / 2;
    let stB = stake / 2;

    // correggi stake minimi
    const fixed = adjustStakeMin(stA, stB, stake);
    stA = fixed.a;
    stB = fixed.b;

    // Risultati possibili:
    // +0 goal, +1 goal, +2 goal
    let out0, out1, out2;

    if (frac === 0.75) {
        // esempio 1.75:
        // +0 → persa (full lose)
        // +1 → mezza win + mezza void
        // +2 → full win
        out0 = `<span class='neg'>Persa</span>`;
        out1 = `<span class='half'>Mezza Vinta / Mezza Void</span>`;
        out2 = `<span class='pos'>Vinta</span>`;
    }
    else if (frac === 0.25) {
        // esempio 1.25:
        // +0 → mezza persa
        // +1 → full win
        // +2 → full win
        out0 = `<span class='half'>Mezza Persa</span>`;
        out1 = `<span class='pos'>Vinta</span>`;
        out2 = `<span class='pos'>Vinta</span>`;
    }
    else {
        out0 = "Linea non valida (non .25/.75)";
        out1 = "-";
        out2 = "-";
    }

    const box = document.getElementById("al_res");
    box.style.display = "block";

    box.innerHTML = `
        Stake A (bassa): <b>${stA}</b><br>
        Stake B (alta): <b>${stB}</b><br><br>

        +0 goal: ${out0}<br>
        +1 goal: ${out1}<br>
        +2 goal: ${out2}<br>
    `;
}



// ============================================
// GOALOO / SOCCERSTATS SEARCH
// ============================================

function buildQuery() {
    let h = document.getElementById("t_home").value.trim();
    let a = document.getElementById("t_away").value.trim();
    let d = document.getElementById("t_date").value.trim();
    if (!h || !a) return "";
    let q = encodeURIComponent(h + " " + a + (d ? " " + d : ""));
    return q;
}

function openGoaloo() {
    const q = buildQuery();
    if (!q) return;
    window.open("https://www.goaloo.com/search?kw=" + q, "_blank");
}

function openSoccerstats() {
    const q = buildQuery();
    if (!q) return;
    window.open("https://www.soccerstats.com/search.asp?match=" + q, "_blank");
}

</script>
<script>
// =============================================
// STORAGE
// =============================================
function loadStorico() {
    return JSON.parse(localStorage.getItem("storico") || "[]");
}
function saveStorico(arr) {
    localStorage.setItem("storico", JSON.stringify(arr));
}



// =============================================
// CALCOLO PROFITTO IN BASE AL TIPO DI BET
// =============================================
function computeProfit(row) {

    // ========= CASO SPECIALE: ASIAN OVER LIVE =========
    if (row.tipo === "Asian Over Live") {

        const stake = row.stakeA + row.stakeB; // stake totale unico
        const qA = row.quotaA;
        const qB = row.quotaB;

        let profit = 0;

        switch (row.esito) {

            case "Vinte entrambe":
                // full win → stake * quota media?
                profit = stake * ((qA + qB) / 2) - stake;
                break;

            case "Perse entrambe":
                profit = -stake;
                break;

            case "Solo A vinta":
                // mezza vinta / mezza persa
                // A vince → stake/2 * (qA-1)
                // B perde → - stake/2
                const half = stake / 2;
                profit = half * (qA - 1) - half;
                break;

            case "Solo B vinta":
                // mezza persa / mezza void
                const h = stake / 2;
                profit = -h + 0; // B viene voidata
                break;

            default:
                profit = 0;
        }

        return roundBook(profit);
    }


    // ========= TUTTI GLI ALTRI TIPI (LOGICA NORMALE) =========
    let profit = 0;

    switch (row.esito) {

        case "Vinte entrambe":
            profit = row.stakeA * (row.quotaA - 1) + row.stakeB * (row.quotaB - 1);
            break;

        case "Perse entrambe":
            profit = -(row.stakeA + row.stakeB);
            break;

        case "Solo A vinta":
            // A vinta, B persa
            profit = row.stakeA * (row.quotaA - 1) - row.stakeB;
            break;

        case "Solo B vinta":
            profit = row.stakeB * (row.quotaB - 1) - row.stakeA;
            break;

        default:
            profit = 0;
    }

    return roundBook(profit);
}



// =============================================
// AGGIUNGI ALLO STORICO
// =============================================
function addStorico() {

    let arr = loadStorico();

    const data = document.getElementById("st_data").value;
    const tipo = document.getElementById("st_tipo").value;
    const partita = document.getElementById("st_partita").value;
    const qA = parseFloat(document.getElementById("st_qA").value);
    const qB = parseFloat(document.getElementById("st_qB").value);
    const sA = parseFloat(document.getElementById("st_sA").value);
    const sB = parseFloat(document.getElementById("st_sB").value);
    const esito = document.getElementById("st_esito").value;

    let row = {
        id: Date.now(),
        data,
        tipo,
        partita,
        quotaA: isNaN(qA) ? 0 : qA,
        quotaB: isNaN(qB) ? 0 : qB,
        stakeA: isNaN(sA) ? 0 : sA,
        stakeB: isNaN(sB) ? 0 : sB,
        esito
    };

    row.profit = computeProfit(row);

    arr.push(row);
    saveStorico(arr);

    renderStorico();
    alert("Aggiunto allo storico.");
}



// =============================================
// RENDER STORICO IN LISTA
// =============================================
function renderStorico() {

    let arr = loadStorico();
    const box = document.getElementById("storicoList");
    box.innerHTML = "";

    if (!arr.length) {
        box.innerHTML = "<i>Nessuna giocata registrata.</i>";
        return;
    }

    arr.sort((a,b)=> b.id - a.id);

    arr.forEach(r => {

        const esitoClass = (r.esito === "Non giocata") ? "esitoPending" : "esitoDone";

        const row = document.createElement("div");
        row.className = "stRow";

        row.innerHTML = `
            <b>${r.data}</b> — ${r.partita} <br>
            <small>${r.tipo}</small><br>

            Quote: A ${r.quotaA} — B ${r.quotaB}<br>
            Stake: A ${r.stakeA} — B ${r.stakeB}<br>

            Esito: <span class='${esitoClass}'>${r.esito}</span><br>
            Profitto: <b style="color:${r.profit>=0 ? '#00b300':'#ff3333'}">
                ${r.profit}
            </b>
            <br>
            <button onclick="editStorico(${r.id})">Modifica</button>
            <button onclick="deleteStorico(${r.id})" style="margin-top:6px;background:#ff4444">Elimina</button>
        `;

        box.appendChild(row);
    });
}



// =============================================
// DELETE RIGA
// =============================================
function deleteStorico(id) {
    if (!confirm("Confermi eliminazione?")) return;
    let arr = loadStorico();
    arr = arr.filter(r => r.id !== id);
    saveStorico(arr);
    renderStorico();
}



// =============================================
// EDIT RIGA
// =============================================
function editStorico(id) {

    let arr = loadStorico();
    let r = arr.find(x => x.id === id);
    if (!r) return;

    let newPartita = prompt("Partita:", r.partita);
    let newEsito = prompt(
        "Esito (Vinte entrambe / Perse entrambe / Solo A vinta / Solo B vinta / Non giocata):",
        r.esito
    );
    let newQA = parseFloat(prompt("Quota A:", r.quotaA));
    let newQB = parseFloat(prompt("Quota B:", r.quotaB));
    let newSA = parseFloat(prompt("Stake A:", r.stakeA));
    let newSB = parseFloat(prompt("Stake B:", r.stakeB));

    r.partita = newPartita || r.partita;
    r.esito = newEsito || r.esito;

    r.quotaA = isNaN(newQA) ? r.quotaA : newQA;
    r.quotaB = isNaN(newQB) ? r.quotaB : newQB;
    r.stakeA = isNaN(newSA) ? r.stakeA : newSA;
    r.stakeB = isNaN(newSB) ? r.stakeB : newSB;

    // Ricalcolo corretto del profitto
    r.profit = computeProfit(r);

    saveStorico(arr);
    renderStorico();
}

</script>
<script>
// ===================================================
// DASHBOARD: WINRATE + PROFIT + EQUITY
// ===================================================
function updateDashboard() {
    const arr = loadStorico();
    const finished = arr.filter(r => r.esito !== "Non giocata");

    let betsA = 0, betsB = 0, winA = 0, winB = 0;
    let profit = 0;

    finished.forEach(r => {
        profit += (typeof r.profit === "number" ? r.profit : 0);

        if (r.stakeA > 0 && r.quotaA > 0) {
            betsA++;
            if (r.esito === "Vinte entrambe" || r.esito === "Solo A vinta") {
                winA++;
            }
        }
        if (r.stakeB > 0 && r.quotaB > 0) {
            betsB++;
            if (r.esito === "Vinte entrambe" || r.esito === "Solo B vinta") {
                winB++;
            }
        }
    });

    const totalBets = betsA + betsB;
    const totalWins = winA + winB;
    const winRate = totalBets > 0 ? (totalWins / totalBets * 100) : 0;
    const wrA = betsA > 0 ? (winA / betsA * 100) : 0;
    const wrB = betsB > 0 ? (winB / betsB * 100) : 0;

    document.getElementById("d_bet").textContent = totalBets;
    document.getElementById("d_win").textContent = totalWins;
    document.getElementById("d_winp").textContent = winRate.toFixed(1) + "%";

    document.getElementById("d_wA").textContent = wrA.toFixed(1) + "%";
    document.getElementById("d_wB").textContent = wrB.toFixed(1) + "%";

    document.getElementById("d_profit").textContent =
        (profit >= 0 ? "+" : "") + profit.toFixed(2);

    drawWinRateChart(winRate);
    drawEquityChart(arr);
}

// Disegno Winrate "donut" a mano
function drawWinRateChart(winRate) {
    const canvas = document.getElementById("winRateChart");
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    const w = canvas.width = 220;
    const h = canvas.height = 220;
    ctx.clearRect(0,0,w,h);

    const cx = w/2, cy = h/2;
    const rOuter = 90;
    const rInner = 55;

    const radWin = (Math.PI*2) * (winRate/100);

    // anello base (rosso lose)
    ctx.beginPath();
    ctx.arc(cx, cy, rOuter, 0, Math.PI*2);
    ctx.arc(cx, cy, rInner, Math.PI*2, 0, true);
    ctx.closePath();
    ctx.fillStyle = "#ff3333";
    ctx.fill();

    // anello verde (win)
    ctx.beginPath();
    ctx.arc(cx, cy, rOuter, -Math.PI/2, -Math.PI/2 + radWin);
    ctx.arc(cx, cy, rInner, -Math.PI/2 + radWin, -Math.PI/2, true);
    ctx.closePath();
    ctx.fillStyle = "#00b300";
    ctx.fill();

    // testo in centro
    ctx.fillStyle = "#111";
    ctx.font = "bold 24px -apple-system, system-ui";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(winRate.toFixed(1) + "%", cx, cy);
}

// Disegno Equity line
function drawEquityChart(arr) {
    const canvas = document.getElementById("equityChart");
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    const w = canvas.width = canvas.clientWidth || 320;
    const h = canvas.height = 220;
    ctx.clearRect(0,0,w,h);

    if (!arr.length) {
        ctx.fillStyle = "#999";
        ctx.font = "14px -apple-system";
        ctx.fillText("Nessuna giocata", 10, h/2);
        return;
    }

    // ordino per data
    let sorted = arr.slice().sort((a,b)=> a.data.localeCompare(b.data) || (a.id - b.id));

    let xVals = [];
    let yVals = [];
    let cum = 0;

    sorted.forEach((r, i)=>{
        cum += (typeof r.profit === "number" ? r.profit : 0);
        xVals.push(i);
        yVals.push(cum);
    });

    const minY = Math.min.apply(null, yVals);
    const maxY = Math.max.apply(null, yVals);

    const pad = 20;
    const innerW = w - pad*2;
    const innerH = h - pad*2;

    function mapX(i) {
        if (xVals.length === 1) return pad + innerW/2;
        return pad + (i / (xVals.length - 1)) * innerW;
    }
    function mapY(v) {
        if (maxY === minY) return pad + innerH/2;
        return pad + innerH - ((v - minY) / (maxY - minY)) * innerH;
    }

    // asse X
    ctx.strokeStyle = "#ccc";
    ctx.beginPath();
    ctx.moveTo(pad, h - pad);
    ctx.lineTo(w - pad, h - pad);
    ctx.stroke();

    // linea equity
    ctx.strokeStyle = "#0a84ff";
    ctx.lineWidth = 2;
    ctx.beginPath();
    yVals.forEach((val, idx)=>{
        const x = mapX(idx);
        const y = mapY(val);
        if (idx === 0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();

    // ultimo punto
    const lastX = mapX(yVals.length - 1);
    const lastY = mapY(yVals[yVals.length - 1]);
    ctx.fillStyle = "#0a84ff";
    ctx.beginPath();
    ctx.arc(lastX, lastY, 3.5, 0, Math.PI*2);
    ctx.fill();
}



// ===================================================
// RIEPILOGO GIORNALIERO
// ===================================================
function updateDaily() {
    const arr = loadStorico();
    const today = new Date().toISOString().slice(0,10);

    const todayRows = arr.filter(r => r.data === today && r.esito !== "Non giocata");

    let bets = 0, wins = 0, profit = 0;

    todayRows.forEach(r => {
        profit += (typeof r.profit === "number" ? r.profit : 0);

        if (r.stakeA > 0 && r.quotaA > 0) {
            bets++;
            if (r.esito === "Vinte entrambe" || r.esito === "Solo A vinta") wins++;
        }
        if (r.stakeB > 0 && r.quotaB > 0) {
            bets++;
            if (r.esito === "Vinte entrambe" || r.esito === "Solo B vinta") wins++;
        }
    });

    const wr = bets > 0 ? (wins / bets * 100) : 0;

    document.getElementById("dy_profit").textContent =
        (profit>=0?"+":"") + profit.toFixed(2);
    document.getElementById("dy_bet").textContent = bets;
    document.getElementById("dy_wp").textContent  = wr.toFixed(1) + "%";

    // Stato target / stop non possiamo calcolarlo senza bankroll,
    // quindi lasciamo un testo neutro.
    let stato = "";
    if (bets === 0) stato = "Nessuna bet completata oggi";
    document.getElementById("dy_state").textContent = stato;
}



// ===================================================
// INIT
// ===================================================
window.addEventListener("load", () => {

    // default tab
    openTab("calc");

    // se non c'è data nello storico, setta oggi di default nel form
    const d = document.getElementById("st_data");
    if (d && !d.value) {
        d.value = new Date().toISOString().slice(0,10);
    }

    renderStorico();
    updateDashboard();
    updateDaily();
});
</script>

</body>
</html>
