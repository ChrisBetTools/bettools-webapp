<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>BetTools</title>

  <!-- PWA / iOS -->
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      color-scheme: light dark;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-font-smoothing: antialiased;
    }

    body {
      margin: 0;
      font-family: -apple-system, system-ui, sans-serif;
      background: #f3f4f6;
      color: #111827;
    }

    /* Tabs in alto */
    .topTabs {
      display: flex;
      background: #e5e7eb;
      border-bottom: 1px solid #d1d5db;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .topTabs button {
      flex: 1;
      padding: 11px 4px;
      border: 0;
      background: transparent;
      font-size: 15px;
      font-weight: 600;
      color: #6b7280;
      cursor: pointer;
    }
    .topTabs button.active {
      background: #ffffff;
      color: #111827;
      border-bottom: 3px solid #2563eb;
    }

    /* Pagine */
    .page {
      display: none;
      padding: 12px;
      padding-bottom: 80px;
    }

    /* Cards */
    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 14px;
      box-shadow: 0 4px 10px rgba(15,23,42,0.06);
    }
    h2 {
      margin: 0 0 8px 0;
      font-size: 18px;
    }
    p.desc {
      margin: 0 0 10px 0;
      font-size: 13px;
      color: #6b7280;
    }

    /* Banner target / stop */
    .banner {
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 13px;
      margin-bottom: 10px;
      font-weight: 600;
    }
    .banner.green {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #6ee7b7;
    }
    .banner.red {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    /* Inputs */
    label {
      font-size: 13px;
      font-weight: 600;
      display: block;
      margin: 6px 0 2px;
    }
    input,
    select {
      width: 100%;
      padding: 9px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      box-sizing: border-box;
      background: #f9fafb;
      color: #111827;
    }
    input:focus,
    select:focus {
      outline: 2px solid #2563eb;
      outline-offset: 0;
      background: #ffffff;
    }

    .row {
      display: flex;
      gap: 8px;
    }
    .row > div {
      flex: 1;
    }

    /* Buttons */
    .btn {
      width: 100%;
      padding: 11px;
      margin-top: 10px;
      border-radius: 9px;
      border: none;
      font-size: 15px;
      font-weight: 600;
      color: #ffffff;
      background: #2563eb;
      cursor: pointer;
      transition: background 0.18s ease, transform 0.06s ease;
    }
    .btn:active {
      transform: scale(0.97);
    }
    .btn.secondary {
      background: #6b7280;
    }
    .btn.danger {
      background: #ef4444;
    }
    .btn.small {
      padding: 6px 10px;
      font-size: 12px;
      width: auto;
    }

    .muted {
      font-size: 13px;
      color: #6b7280;
    }

    .resultBox {
      margin-top: 10px;
      font-size: 13px;
      background: #f9fafb;
      border-radius: 8px;
      padding: 10px;
      border: 1px solid #e5e7eb;
    }

    .text-red { color: #ef4444; }
    .text-green { color: #10b981; }
    .text-blue { color: #2563eb; }
    .text-amber { color: #f59e0b; }
    .text-gray { color: #6b7280; }

    /* Storico */
    table.storico {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    table.storico th,
    table.storico td {
      border-bottom: 1px solid #e5e7eb;
      padding: 6px 4px;
      text-align: left;
      vertical-align: middle;
    }
    table.storico th {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .03em;
      color: #6b7280;
    }

    /* Filters */
    .filtersRow {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }
    .filtersRow select {
      flex: 1 1 130px;
    }

    /* KPI */
    .kpiGrid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .kpiItem {
      flex: 1 1 140px;
      min-width: 130px;
    }
    .kpiValue {
      font-size: 20px;
      font-weight: 700;
    }
    .kpiLabel {
      font-size: 12px;
      color: #6b7280;
    }

    /* WinRate */
    .winRateWrap {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .winRateSide {
      width: 25%;
      text-align: center;
    }
    .winRateSide .value {
      font-size: 20px;
      font-weight: 700;
    }
    .winRateSide .label {
      font-size: 13px;
      color: #6b7280;
    }
    .winRateCenter {
      width: 120px;
      height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Range bottoni */
    .rangeRow {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-bottom: 6px;
      margin-top: 4px;
    }
    .rangeBtn {
      padding: 3px 8px;
      font-size: 11px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      background: #f3f4f6;
      cursor: pointer;
    }
    .rangeBtn.active {
      background: #2563eb;
      color: white;
      border-color: #2563eb;
    }

    /* Modali */
    #addModal,
    #editModal {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modalCard {
      background: white;
      border-radius: 14px;
      padding: 16px;
      width: 92%;
      max-width: 420px;
      box-shadow: 0 20px 40px rgba(15,23,42,0.4);
    }

    /* Riepilogo giornaliero */
    table.daily {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    table.daily th,
    table.daily td {
      border-bottom: 1px solid #e5e7eb;
      padding: 6px 4px;
      text-align: left;
    }
    table.daily th {
      font-size: 11px;
      text-transform: uppercase;
      color: #6b7280;
    }


    /* Storico cards */
    .storicoCard {
      background: #ffffff;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
      border: 1px solid #e5e7eb;
    }
    .storicoCard .topLine {
      display:flex;
      justify-content: space-between;
      gap:8px;
      align-items: baseline;
      margin-bottom: 6px;
    }
    .storicoCard .meta {
      font-size: 12px;
      color: #6b7280;
      font-weight: 600;
    }
    .storicoCard .title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .storicoCard .grid2 {
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      font-size: 12px;
      margin-bottom: 8px;
    }
    .storicoCard .grid2 > div {
      flex: 1 1 160px;
      min-width: 140px;
    }
    .storicoCard .actions {
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top: 6px;
    }

    /* Dark mode */
    @media (prefers-color-scheme: dark) {
      body {
        background: #111827;
        color: #f9fafb;
      }
      .topTabs {
        background: #1f2937;
        border-bottom-color: #374151;
      }
      .topTabs button {
        color: #9ca3af;
      }
      .topTabs button.active {
        background: #111827;
        color: #f9fafb;
      }
      .card {
        background: #1f2937;
        box-shadow: none;
      }
      input,
      select {
        background: #111827;
        color: #f9fafb;
        border-color: #374151;
      }
      input:focus,
      select:focus {
        background: #111827;
      }
      .resultBox {
        background: #111827;
        border-color: #374151;
      }
      table.storico th,
      table.storico td {
        border-bottom-color: #374151;
      }
      table.daily th,
      table.daily td {
        border-bottom-color: #374151;
      }
      .modalCard {
        background: #111827;
      }
      .banner.green {
        background: rgba(16,185,129,0.2);
        border-color: rgba(16,185,129,0.6);
        color: #6ee7b7;
      }
      .banner.red {
        background: rgba(239,68,68,0.2);
        border-color: rgba(239,68,68,0.6);
        color: #fecaca;
      }
      .storicoCard { background:#111827; border-color:#374151; }
      .storicoCard .meta { color:#9ca3af; }

    }
  </style>
</head>
<body>

<!-- TABS -->
<div class="topTabs">
  <button id="tab_calc" class="active" onclick="showTab('calc')">Calcolatori</button>
  <button id="tab_storico" onclick="showTab('storico')">Storico</button>
  <button id="tab_dash" onclick="showTab('dash')">Dashboard</button>
  <button id="tab_daily" onclick="showTab('daily')">Riepilogo</button>
</div>

<!-- ============== PAGINA CALCOLATORI ============== -->
<div id="page_calc" class="page" style="display:block;">

  <!-- Banner target / stop -->
  <div id="dayBanner" style="display:none;"></div>

  <!-- Asian Line Intera -->
  <div class="card">
    <h2>Asian Line Intera</h2>
    <p class="desc">
      Simula una linea asiatica intera con due Over. Se <b>Quota B = 0</b>, tutta la puntata va su Quota A.
    </p>

    <label>Puntata Totale (€)</label>
    <input id="al_tot" type="number" step="0.1">

    <label>Quota A – Over Minore</label>
    <input id="al_qA" type="number" step="0.01">

    <label>Quota B – Over Maggiore (0 se non giocata)</label>
    <input id="al_qB" type="number" step="0.01" value="0">

    <button class="btn" onclick="calcolaAsianIntera()">Calcola</button>
    <div id="al_out" class="resultBox" style="display:none;"></div>
    <button class="btn secondary" onclick="apriAddModalFromCalc('Asian Line Intera')">
      + Aggiungi allo storico
    </button>
  </div>

  <!-- Protezione Void -->
  <div class="card">
    <h2>Protezione Void (Giocata Principale + Copertura)</h2>
    <p class="desc">
      Usa una seconda giocata a quota bassa per coprire (quasi) la perdita della principale.
      Se <b>Quota B = 0</b>, tutta la puntata va su Quota A.
    </p>

    <label>Puntata Totale (€)</label>
    <input id="pv_tot" type="number" step="0.1">

    <label>Quota A (Giocata principale)</label>
    <input id="pv_qA" type="number" step="0.01">

    <label>Quota B (Copertura – 0 se non giocata)</label>
    <input id="pv_qB" type="number" step="0.01" value="0">

    <button class="btn" onclick="calcolaProtezione()">Calcola</button>
    <div id="pv_out" class="resultBox" style="display:none;"></div>
    <button class="btn secondary" onclick="apriAddModalFromCalc('Protezione Void')">
      + Aggiungi allo storico
    </button>
  </div>

  <!-- Asian Over Live (0.25 / 0.75) -->
  <div class="card">
    <h2>Asian Over Live (0.25 / 0.75)</h2>
    <p class="desc">
      Dividi la puntata su due Over per simulare una linea <b>X.25</b> o <b>X.75</b> durante il live.<br>
      Inserisci i gol già segnati al momento della giocata, la puntata totale e le due quote.
    </p>

    <label>Tipo linea</label>
    <select id="ao_tipo">
      <option value="0.25">Over X.25</option>
      <option value="0.75">Over X.75</option>
    </select>

    <label>Gol già segnati al momento della giocata (totali)</label>
    <input id="ao_g0" type="number" step="1" min="0">

    <label>Puntata Totale (€)</label>
    <input id="ao_tot" type="number" step="0.1">

    <label>Quota Over Minore</label>
    <input id="ao_qLow" type="number" step="0.01">

    <label>Quota Over Maggiore</label>
    <input id="ao_qHigh" type="number" step="0.01">

    <button class="btn" onclick="calcolaAsianOverLive()">Calcola</button>
    <div id="ao_out" class="resultBox" style="display:none;"></div>

    <button class="btn secondary" onclick="apriAddModalFromCalc('Asian Over Live')">
      + Aggiungi allo storico
    </button>
  </div>

  <!-- Link Statistiche -->
  <div class="card">
    <h2>Link Statistiche (Goaloo / SoccerStats)</h2>
    <p class="desc">
      Inserisci la partita (es. <b>Inter - Liverpool</b>). Verrà proposta una ricerca Google con filtro sito.
    </p>

    <label>Partita</label>
    <input id="match_name" type="text" placeholder="Inter - Liverpool">

    <button class="btn" onclick="openGoaloo()">Apri Goaloo (Google)</button>
    <button class="btn secondary" onclick="openSoccerStats()">Apri SoccerStats (Google)</button>

    <p id="match_info" class="muted"></p>
  </div>

</div> <!-- fine page_calc -->


<!-- ============== PAGINA STORICO ============== -->
<div id="page_storico" class="page">

  <div class="card">
    <h2>Storico Giocate</h2>

    <div class="filtersRow" style="margin-top:6px;">
      <select id="f_tipo" onchange="renderStorico(); aggiornaDashboard(); buildDailySummary();">
        <option value="all">Tutti i tipi</option>
        <option value="Asian Line Intera">Asian Line Intera</option>
        <option value="Protezione Void">Protezione Void</option>
        <option value="Asian Over Live">Asian Over Live</option>
        <option value="2 More Corner FT">2 More Corner FT</option>
        <option value="Next Goal Home - Pari">Next Goal Home - Pari</option>
        <option value="New Neigh Casa">New Neigh Casa</option>
        <option value="New Dominio Home">New Dominio Home</option>
        <option value="Secondo Goal HT Lite">Secondo Goal HT Lite</option>
      </select>

      <select id="f_periodo" onchange="renderStorico(); aggiornaDashboard(); buildDailySummary();">
        <option value="tutto">Tutto</option>
        <option value="oggi">Oggi</option>
        <option value="ieri">Ieri</option>
        <option value="sett_corr">Settimana in corso</option>
        <option value="sett_prev">Settimana precedente</option>
        <option value="mese_corr">Mese in corso</option>
        <option value="mese_prev">Mese precedente</option>
      </select>
    </div>

    <div style="margin-bottom:8px;">
      <button class="btn small" onclick="apriAddModalManuale()">+ Nuova riga manuale</button>
      <button class="btn small secondary" onclick="exportCSV()">Esporta CSV</button>
      <button class="btn small danger" onclick="resetStorico()">Cancella storico</button>
    </div>

    <div id="storicoBox" style="margin-top:8px;"></div>

  </div>

</div> <!-- fine storico -->


<!-- ============== PAGINA DASHBOARD ============== -->
<div id="page_dash" class="page">

  <div class="card">
    <h2>Dashboard</h2>

    <div class="filtersRow" style="margin-top:6px;">
      <select id="d_tipo" onchange="aggiornaDashboard();">
        <option value="all">Tutti i tipi</option>
        <option value="Asian Line Intera">Asian Line Intera</option>
        <option value="Protezione Void">Protezione Void</option>
        <option value="Asian Over Live">Asian Over Live</option>
        <option value="2 More Corner FT">2 More Corner FT</option>
        <option value="Next Goal Home - Pari">Next Goal Home - Pari</option>
        <option value="New Neigh Casa">New Neigh Casa</option>
        <option value="New Dominio Home">New Dominio Home</option>
        <option value="Secondo Goal HT Lite">Secondo Goal HT Lite</option>
      </select>

      <select id="d_periodo" onchange="aggiornaDashboard();">
        <option value="tutto">Tutto</option>
        <option value="oggi">Oggi</option>
        <option value="ieri">Ieri</option>
        <option value="sett_corr">Settimana in corso</option>
        <option value="sett_prev">Settimana precedente</option>
        <option value="mese_corr">Mese in corso</option>
        <option value="mese_prev">Mese precedente</option>
      </select>
    </div>

    <div class="kpiGrid">
      <div class="kpiItem">
        <div id="kpi_profit" class="kpiValue">0€</div>
        <div class="kpiLabel">Total Profit</div>
      </div>
      <div class="kpiItem">
        <div id="kpi_yield" class="kpiValue">0%</div>
        <div class="kpiLabel">Yield</div>
      </div>
      <div class="kpiItem">
        <div id="kpi_odd" class="kpiValue">0</div>
        <div class="kpiLabel">Avg. Odd</div>
      </div>
      <div class="kpiItem">
        <div id="kpi_stake" class="kpiValue">0€</div>
        <div class="kpiLabel">Avg. Stake (match)</div>
      </div>
      <div class="kpiItem">
        <div id="kpi_matches" class="kpiValue">0</div>
        <div class="kpiLabel">Total Matches</div>
      </div>
      <div class="kpiItem">
        <div id="kpi_bets" class="kpiValue">0</div>
        <div class="kpiLabel">Total Bets (A+B)</div>
      </div>
      <div class="kpiItem">
        <div id="kpi_wr_total" class="kpiValue">0%</div>
        <div class="kpiLabel">Winrate Totale (bets)</div>
      </div>
      <div class="kpiItem">
        <div id="kpi_wr_A" class="kpiValue">0%</div>
        <div class="kpiLabel">Winrate Quota A</div>
      </div>
      <div class="kpiItem">
        <div id="kpi_wr_B" class="kpiValue">0%</div>
        <div class="kpiLabel">Winrate Quota B</div>
      </div>
    </div>
  </div>

  <!-- Win Rate donut -->
  <div class="card">
    <h2 style="text-align:center;">Win Rate</h2>
    <div class="winRateWrap">
      <div class="winRateSide">
        <div id="wr_win" class="value" style="color:#16a34a;">0%</div>
        <div class="label">Won</div>
      </div>
      <div class="winRateCenter">
        <canvas id="chartWinRate" width="120" height="120"></canvas>
      </div>
      <div class="winRateSide">
        <div id="wr_lost" class="value" style="color:#ef4444;">0%</div>
        <div class="label">Lost</div>
      </div>
    </div>
  </div>

  <!-- Profit Chart -->
  <div class="card">
    <h2>Profit Chart</h2>
    <div class="rangeRow">
      <button class="rangeBtn active" data-range="all" onclick="setRange('all')">all</button>
      <button class="rangeBtn" data-range="1m" onclick="setRange('1m')">1m</button>
      <button class="rangeBtn" data-range="6m" onclick="setRange('6m')">6m</button>
      <button class="rangeBtn" data-range="12m" onclick="setRange('12m')">12m</button>
    </div>
    <canvas id="chartProfit" height="220"></canvas>
  </div>

  <!-- Stake Engine -->
  <div class="card">
    <h2>Stake consigliato</h2>

    <label>Bankroll iniziale (€)</label>
    <input id="br_start" type="number" step="0.1" oninput="saveBankrollStart(); aggiornaDashboard(); buildDailySummary();">

    <p><strong>Bankroll attuale:</strong> <span id="br_current">-</span></p>
    <p><strong>Δ vs iniziale:</strong> <span id="br_delta">-</span></p>

    <p><strong>Stake Standard:</strong> <span id="stk_std">-</span></p>
    <p><strong>Stake High-Edge:</strong> <span id="stk_high">-</span></p>

    <p id="stk_note" class="text-gray" style="font-size:13px;"></p>
  </div>

</div> <!-- fine dashboard -->


<!-- ============== PAGINA RIEPILOGO GIORNALIERO ============== -->
<div id="page_daily" class="page">

  <div class="card">
    <h2>Riepilogo</h2>
    <div class="filtersRow" style="margin-top:10px;">
      <select id="sum_scope" onchange="buildDailySummary();">
        <option value="day" selected>Giorno</option>
        <option value="week">Settimana</option>
        <option value="month">Mese</option>
      </select>
    </div>
    <p class="desc">
      Per ogni giorno vedi profitto, numero di bets, winrate e stato rispetto a <b>target +3%</b> e <b>stop loss -10%</b>
      del bankroll a inizio giornata.
    </p>
    <div id="dailyBox"></div>
  </div>

</div>
<!-- ============== MODALE AGGIUNTA ============== -->
<div id="addModal">
  <div class="modalCard">
    <h2 id="am_title">Aggiungi allo storico</h2>

    <input type="hidden" id="am_mode" value="calc">

    <label>Data</label>
    <input id="am_data" type="date">

    <label>Partita</label>
    <input id="am_partita" placeholder="Es: Inter - Liverpool">

    <label>Tipo scommessa</label>
    <select id="am_tipo">
      <option value="Asian Line Intera">Asian Line Intera</option>
      <option value="Protezione Void">Protezione Void</option>
      <option value="Asian Over Live">Asian Over Live</option>
      <option value="2 More Corner FT">2 More Corner FT</option>
      <option value="Next Goal Home - Pari">Next Goal Home - Pari</option>
      <option value="New Neigh Casa">New Neigh Casa</option>
      <option value="New Dominio Home">New Dominio Home</option>
      <option value="Secondo Goal HT Lite">Secondo Goal HT Lite</option>
    </select>

    <div class="row">
      <div>
        <label>Quota A</label>
        <input id="am_qA" type="number" step="0.01">
      </div>
      <div>
        <label>Quota B (0 se non giocata)</label>
        <input id="am_qB" type="number" step="0.01" value="0">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Stake A (€)</label>
        <input id="am_sA" type="number" step="0.1">
      </div>
      <div>
        <label>Stake B (€)</label>
        <input id="am_sB" type="number" step="0.1">
      </div>
    </div>

    <label>Esito</label>
    <select id="am_esito">
      <option value="Non giocata">Non giocata</option>
      <option value="Vinte entrambe">Vinte entrambe</option>
      <option value="Solo A vinta">Solo A vinta</option>
      <option value="Solo B vinta">Solo B vinta</option>
      <option value="Perse entrambe">Perse entrambe</option>
    </select>

    <button class="btn" onclick="confermaAddModal()">Salva</button>
    <button class="btn secondary" onclick="chiudiAddModal()">Chiudi</button>
  </div>
</div>

<!-- ============== MODALE EDIT ============== -->
<div id="editModal">
  <div class="modalCard">
    <h2>Modifica Giocata</h2>

    <input type="hidden" id="em_id">

    <label>Data</label>
    <input id="em_data" type="date">

    <label>Partita</label>
    <input id="em_partita" type="text">

    <label>Tipo scommessa</label>
    <select id="em_tipo">
      <option value="Asian Line Intera">Asian Line Intera</option>
      <option value="Protezione Void">Protezione Void</option>
      <option value="Asian Over Live">Asian Over Live</option>
      <option value="2 More Corner FT">2 More Corner FT</option>
      <option value="Next Goal Home - Pari">Next Goal Home - Pari</option>
      <option value="New Neigh Casa">New Neigh Casa</option>
      <option value="New Dominio Home">New Dominio Home</option>
      <option value="Secondo Goal HT Lite">Secondo Goal HT Lite</option>
    </select>

    <div class="row">
      <div>
        <label>Quota A</label>
        <input id="em_qA" type="number" step="0.01">
      </div>
      <div>
        <label>Quota B (0 se non giocata)</label>
        <input id="em_qB" type="number" step="0.01">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Stake A (€)</label>
        <input id="em_sA" type="number" step="0.1">
      </div>
      <div>
        <label>Stake B (€)</label>
        <input id="em_sB" type="number" step="0.1">
      </div>
    </div>

    <label>Esito</label>
    <select id="em_esito">
      <option value="Non giocata">Non giocata</option>
      <option value="Vinte entrambe">Vinte entrambe</option>
      <option value="Solo A vinta">Solo A vinta</option>
      <option value="Solo B vinta">Solo B vinta</option>
      <option value="Perse entrambe">Perse entrambe</option>
    </select>

    <button class="btn" onclick="saveEdit()">Salva</button>
    <button class="btn secondary" onclick="closeEdit()">Chiudi</button>
  </div>
</div>
<script>
/* ========= Stato globale ========= */
const LS_KEY = 'bettools_storico';
const LS_BR  = 'bettools_bankroll';

let lastCalc = null;      // {quotaA, quotaB, stakeA, stakeB}
let equityRange = 'all';
let winChartObj = null;
let profitChartObj = null;

/* ========= Utility ========= */
function safeNum(v) {
  const n = parseFloat(v);
  return isNaN(n) ? 0 : n;
}
function todayISO() {
  return new Date().toISOString().slice(0, 10);
}
function cloneDate(d) {
  const x = new Date(d);
  x.setHours(0,0,0,0);
  return x;
}

function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }

/* ========= Tipi scommessa custom ========= */
const LS_TYPES = 'bettools_types';
const DEFAULT_TYPES = [
  'Asian Line Intera',
  'Protezione Void',
  'Asian Over Live',
  '2 More Corner FT',
  'Next Goal Home - Pari',
  'New Neigh Casa',
  'New Dominio Home',
  'Secondo Goal HT Lite'
];

function loadTypes() {
  try {
    const raw = localStorage.getItem(LS_TYPES);
    const arr = raw ? JSON.parse(raw) : [];
    const clean = Array.isArray(arr) ? arr.filter(x => typeof x === 'string' && x.trim().length) : [];
    const merged = Array.from(new Set([...DEFAULT_TYPES, ...clean.map(x => x.trim())]));
    return merged;
  } catch {
    return DEFAULT_TYPES.slice();
  }
}
function saveTypes(arr) {
  const clean = Array.from(new Set(arr.map(x => (x||'').trim()).filter(x => x)));
  localStorage.setItem(LS_TYPES, JSON.stringify(clean));
}
function populateSelectWithTypes(sel, includeAll) {
  if (!sel) return;
  const cur = sel.value;
  const types = loadTypes();
  sel.innerHTML = '';
  if (includeAll) {
    const optAll = document.createElement('option');
    optAll.value = 'all';
    optAll.textContent = 'Tutti i tipi';
    sel.appendChild(optAll);
  }
  types.forEach(t => {
    const opt = document.createElement('option');
    opt.value = t;
    opt.textContent = t;
    sel.appendChild(opt);
  });
  const optAdd = document.createElement('option');
  optAdd.value = '__add__';
  optAdd.textContent = '➕ Aggiungi nuovo tipo';
  sel.appendChild(optAdd);

  // ripristina selezione se possibile
  if (cur && Array.from(sel.options).some(o => o.value === cur)) sel.value = cur;
  else if (includeAll) sel.value = 'all';
}
function initTipoSelects() {
  populateSelectWithTypes(document.getElementById('f_tipo'), true);
  populateSelectWithTypes(document.getElementById('d_tipo'), true);
  populateSelectWithTypes(document.getElementById('am_tipo'), false);
  populateSelectWithTypes(document.getElementById('em_tipo'), false);

  // hook "add new" for all selects
  ['f_tipo','d_tipo','am_tipo','em_tipo'].forEach(id => {
    const sel = document.getElementById(id);
    if (!sel) return;
    sel.addEventListener('change', () => {
      if (sel.value !== '__add__') return;
      const name = prompt('Nome nuovo tipo di scommessa:');
      if (!name) { // ripristina
        populateSelectWithTypes(sel, id==='f_tipo' || id==='d_tipo');
        return;
      }
      const types = loadTypes();
      types.push(name.trim());
      saveTypes(types);
      initTipoSelects();
      sel.value = name.trim();
      // trigger downstream refresh
      if (id === 'f_tipo') { renderStorico(); aggiornaDashboard(); buildDailySummary(); }
      if (id === 'd_tipo') { aggiornaDashboard(); }
    });
  });
}

/* ========= Target automatico (invisibile) + overconfidence ========= */
function getStatsQuotaA(tipo, quotaA) {
  // calcola winrate A su storico (per tipo) escludendo Non giocata
  const all = loadStorico().filter(r => r.esito !== 'Non giocata');
  let arr = all;
  if (tipo) arr = arr.filter(r => r.tipo === tipo);

  // conta solo quando stakeA > 0
  let nA = 0, wA = 0;
  arr.forEach(r => {
    if (r.stakeA > 0 && r.quotaA > 0) {
      nA++;
      if (r.esito === 'Solo A vinta' || r.esito === 'Vinte entrambe') wA++;
    }
  });
  const wrA = nA > 0 ? (wA / nA * 100) : 0;
  return { nA, wrA };
}

function calcolaTargetAutomatico(qA, tipo) {
  // default: se storico vuoto -> 5%
  const allPlayed = loadStorico().filter(r => r.esito !== 'Non giocata');
  if (!allPlayed.length) return 5;

  const { nA, wrA } = getStatsQuotaA(tipo);

  // base dalla quota
  let target = clamp((qA - 1) * 10, 5, 15);

  // aggiustamento winrate
  if (nA === 0) {
    target = 5;
  } else if (wrA < 52) target *= 0.7;
  else if (wrA < 56) target *= 0.85;
  else if (wrA < 60) target *= 1.0;
  else if (wrA < 65) target *= 1.15;
  else target *= 1.3;

  // affidabilità
  if (nA < 20) target *= 0.7;
  else if (nA < 50) target *= 0.85;

  // overconfidence checks (silenziosi)
  if (nA < 30 && target > 8) target = 8;
  if (wrA > 65 && nA < 50) target *= 0.85;
  if (qA < 1.45) target = Math.min(target, 7);

  target = clamp(target, 4, 15);
  return roundBook(target);
}

function splitStakePriorA(S, qA, qB, tipoLabel) {
  // se B non giocata
  if (qB <= 1) return { sA: roundBook(S), sB: 0, target: 0 };

  const targetPerc = calcolaTargetAutomatico(qA, tipoLabel);
  const t = targetPerc / 100;

  let sA = (S * (1 + t)) / qA;
  if (sA > S) sA = S;
  let sB = S - sA;

  // prima regola stake minimo 1 con somma preservata
  let adj = adjustStakeMin(S, sA, sB);
  sA = adj.sA;
  sB = adj.sB;

  // arrotonda bookmaker
  sA = roundBook(sA);
  sB = roundBook(S - sA);

  // ri-applica min dopo arrotondamento
  adj = adjustStakeMin(S, sA, sB);
  sA = roundBook(adj.sA);
  sB = roundBook(adj.sB);

  // se ancora impossibile avere entrambi >=1 (S troppo basso) => tutto su A
  if (S < 2 || (sA > 0 && sB > 0 && (sA < 1 || sB < 1))) {
    sA = roundBook(S);
    sB = 0;
  }

  return { sA, sB, target: targetPerc };
}


function roundBook(x) {
  // arrotonda a 1 decimale
  return Math.round(x * 10) / 10;
}

function adjustStakeMin(S, sA, sB) {
  // Se stake totale < 2€, meglio concentrare tutto su A
  if (S < 2) {
    return { sA: S, sB: 0 };
  }

  let A = sA;
  let B = sB;

  // Se abbiamo davvero due puntate
  if (A > 0 && B > 0) {
    if (A < 1) {
      A = 1;
      B = S - A;
    }
    if (B < 1) {
      B = 1;
      A = S - B;
    }
    if (A < 0) A = 0;
    if (B < 0) B = 0;
  }

  return { sA: A, sB: B };
}

/* ========= Tabs ========= */
function showTab(name) {
  ['calc','storico','dash','daily'].forEach(p => {
    document.getElementById('page_'+p).style.display = (p === name ? 'block' : 'none');
    const tabBtn = document.getElementById('tab_'+p);
    if (tabBtn) tabBtn.classList.toggle('active', p === name);
  });
  if (name === 'storico') renderStorico();
  if (name === 'dash')    aggiornaDashboard();
  if (name === 'daily')   buildDailySummary();
}

/* ========= Storage ========= */
function loadStorico() {
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  } catch {
    return [];
  }
}
function saveStorico(arr) {
  localStorage.setItem(LS_KEY, JSON.stringify(arr));
}
function resetStorico() {
  if (!confirm('Vuoi cancellare tutto lo storico?')) return;
  localStorage.removeItem(LS_KEY);
  renderStorico();
  aggiornaDashboard();
  buildDailySummary();
}

function loadBankrollStart() {
  return safeNum(localStorage.getItem(LS_BR));
}
function saveBankrollStart() {
  const v = safeNum(document.getElementById('br_start').value);
  if (v > 0) localStorage.setItem(LS_BR, v.toString());
}

/* ========= Calcolatore Asian Line Intera ========= */
function calcolaAsianIntera() {
  const S = safeNum(document.getElementById('al_tot').value);
  const qA = safeNum(document.getElementById('al_qA').value);
  const qB = safeNum(document.getElementById('al_qB').value);
  const out = document.getElementById('al_out');

  if (S <= 0 || qA <= 1) {
    out.style.display = 'block';
    out.innerHTML = '<span class="text-red">Inserisci puntata > 0 e Quota A > 1.</span>';
    lastCalc = null;
    return;
  }

  let sA = 0, sB = 0;

  if (qB <= 1) {
    sA = roundBook(S);
    sB = 0;
  } else {
    const res = splitStakePriorA(S, qA, qB, 'Asian Line Intera');
    sA = res.sA;
    sB = res.sB;
  }

  const stakeTot = sA + sB;

  const profitLose = -stakeTot;
  const profitAonly = (sA * qA) - stakeTot; // B persa
  const profitBoth = (qB > 1 && sB > 0)
    ? (sA * qA + sB * qB - stakeTot)
    : (sA * qA - sA);

  out.style.display = 'block';
  out.innerHTML =
    `<b>Punta su Over Minore (A):</b> ${sA.toFixed(2)}€ @ ${qA.toFixed(2)}<br>` +
    `<b>Punta su Over Maggiore (B):</b> ${sB.toFixed(2)}€ @ ${qB.toFixed(2)}<br><br>` +
    `<b>Meno gol della linea:</b> <span class="${profitLose>=0?'text-green':'text-red'}">` +
    `${(profitLose>=0?'+':'') + profitLose.toFixed(2)}€</span><br>` +
    `<b>Solo Over Minore vinto:</b> <span class="${profitAonly>=0?'text-green':'text-red'}">` +
    `${(profitAonly>=0?'+':'') + profitAonly.toFixed(2)}€</span><br>` +
    `<b>Entrambe Vinte:</b> <span class="${profitBoth>=0?'text-green':'text-red'}">` +
    `${(profitBoth>=0?'+':'') + profitBoth.toFixed(2)}€</span>`;

  lastCalc = {
    quotaA: qA,
    quotaB: qB,
    stakeA: sA,
    stakeB: sB
  };
}

/* ========= Calcolatore Protezione Void ========= */
function calcolaProtezione() {
  const S  = safeNum(document.getElementById('pv_tot').value);
  const qA = safeNum(document.getElementById('pv_qA').value);
  const qB = safeNum(document.getElementById('pv_qB').value);
  const out = document.getElementById('pv_out');

  if (S <= 0 || qA <= 1) {
    out.style.display = 'block';
    out.innerHTML = '<span class="text-red">Inserisci puntata > 0 e Quota A > 1.</span>';
    lastCalc = null;
    return;
  }

  let sA = 0, sB = 0;

  if (qB <= 1) {
    sA = roundBook(S);
    sB = 0;
  } else {
    const res = splitStakePriorA(S, qA, qB, 'Protezione Void');
    sA = res.sA;
    sB = res.sB;
  }

  const stakeTot = sA + sB;

  const profitLose = -stakeTot;
  const profitAonly = (sA * qA) - stakeTot;
  const profitBonly = (qB > 1 && sB > 0) ? (sB * qB - stakeTot) : -stakeTot;
  const profitBoth = (qB > 1 && sB > 0)
    ? (sA * qA + sB * qB - stakeTot)
    : (sA * qA - sA);

  out.style.display = 'block';
  out.innerHTML =
    `<b>Punta su A (principale):</b> ${sA.toFixed(2)}€ @ ${qA.toFixed(2)}<br>` +
    `<b>Punta su B (secondaria):</b> ${sB.toFixed(2)}€ @ ${qB.toFixed(2)}<br><br>` +
    `<b>Perse entrambe:</b> <span class="${profitLose>=0?'text-green':'text-red'}">` +
    `${(profitLose>=0?'+':'') + profitLose.toFixed(2)}€</span><br>` +
    `<b>Solo A vinta:</b> <span class="${profitAonly>=0?'text-green':'text-red'}">` +
    `${(profitAonly>=0?'+':'') + profitAonly.toFixed(2)}€</span><br>` +
    `<b>Solo B vinta:</b> <span class="${profitBonly>=0?'text-green':'text-red'}">` +
    `${(profitBonly>=0?'+':'') + profitBonly.toFixed(2)}€</span><br>` +
    `<b>Entrambe Vinte:</b> <span class="${profitBoth>=0?'text-green':'text-red'}">` +
    `${(profitBoth>=0?'+':'') + profitBoth.toFixed(2)}€</span>`;

  lastCalc = {
    quotaA: qA,
    quotaB: qB,
    stakeA: sA,
    stakeB: sB
  };
}

/* ========= Asian Over Live ========= */
function calcolaAsianOverLive() {
  const tipo = safeNum(document.getElementById('ao_tipo').value); // 0.25 o 0.75
  const g0   = safeNum(document.getElementById('ao_g0').value);
  const S    = safeNum(document.getElementById('ao_tot').value);
  const qLow = safeNum(document.getElementById('ao_qLow').value);
  const qHigh= safeNum(document.getElementById('ao_qHigh').value);
  const out  = document.getElementById('ao_out');

  if (S <= 0 || qLow <= 1 || qHigh <= 1 || (tipo !== 0.25 && tipo !== 0.75)) {
    out.style.display = 'block';
    out.innerHTML = '<span class="text-red">Inserisci puntata > 0, quote > 1 e scegli 0.25 / 0.75.</span>';
    lastCalc = null;
    return;
  }

  // split stake orientato a quota A (Over Minore) per garantire profitto su scenario "solo A"
  const res = splitStakePriorA(S, qLow, qHigh, 'Asian Over Live');
  let sA = res.sA;
  let sB = res.sB;

  const stakeTot = sA + sB;
  const base = g0;
  const linea = base + tipo;

  function profitPerGoals(T) {
    let profit = 0;

    if (tipo === 0.25) {
      // combo Over base (qLow) & Over base+0.5 (qHigh)
      if (T <= base - 1) {
        profit = -stakeTot;
      } else if (T === base) {
        // push su low, perde high
        profit = -sB;
      } else {
        profit = sA * qLow + sB * qHigh - stakeTot;
      }
    } else {
      // tipo 0.75: combo Over base+0.5 (qLow) & Over base+1.0 (qHigh)
      if (T <= base) {
        profit = -stakeTot;
      } else if (T === base + 1) {
        // low vince, high push
        profit = (sA * qLow - stakeTot) + sB;
      } else {
        profit = sA * qLow + sB * qHigh - stakeTot;
      }
    }
    return roundBook(profit);
  }

  let html = '';
  html += `<b>Linea:</b> Over ${linea.toFixed(2)}<br>`;
  html += `<b>Punta su Over inferiore:</b> ${sA.toFixed(2)}€ @ ${qLow.toFixed(2)}<br>`;
  html += `<b>Punta su Over superiore:</b> ${sB.toFixed(2)}€ @ ${qHigh.toFixed(2)}<br><br>`;
  html += `<b>Risultati (gol aggiuntivi rispetto ai ${g0} attuali):</b><br><ul>`;

  // 0..3 goals aggiuntivi
  for (let add = 0; add <= 3; add++) {
    const T = g0 + add;
    const profit = profitPerGoals(T);
    const cls = profit >= 0 ? 'text-green' : 'text-red';
    html += `<li>+${add} gol → <span class="${cls}">${(profit>=0?'+':'') + profit.toFixed(2)}€</span></li>`;
  }
  html += '</ul>';

  out.style.display = 'block';
  out.innerHTML = html;

  lastCalc = {
    quotaA: qLow,
    quotaB: qHigh,
    stakeA: sA,
    stakeB: sB
  };
}

/* ========= Link statistiche ========= */
function openGoaloo() {
  const m = document.getElementById('match_name').value.trim();
  if (!m) return;
  const q = encodeURIComponent(m + ' site:goaloo.com');
  window.open('https://www.google.com/search?q=' + q, '_blank');
  document.getElementById('match_info').textContent =
    'Ricerca Goaloo per: "' + m + '"';
}
function openSoccerStats() {
  const m = document.getElementById('match_name').value.trim();
  if (!m) return;
  const q = encodeURIComponent(m + ' site:soccerstats.com');
  window.open('https://www.google.com/search?q=' + q, '_blank');
  document.getElementById('match_info').textContent =
    'Ricerca SoccerStats per: "' + m + '"';
}

/* ========= MODALE ADD ========= */
function apriAddModalFromCalc(tipoLabel) {
  const arr = lastCalc;
  document.getElementById('am_mode').value = 'calc';
  document.getElementById('am_title').textContent = 'Aggiungi allo storico';

  document.getElementById('am_data').value = todayISO();
  document.getElementById('am_partita').value = '';
  document.getElementById('am_tipo').value = tipoLabel;

  if (arr) {
    document.getElementById('am_qA').value = arr.quotaA.toFixed(2);
    document.getElementById('am_qB').value = arr.quotaB ? arr.quotaB.toFixed(2) : '0.00';
    document.getElementById('am_sA').value = arr.stakeA.toFixed(1);
    document.getElementById('am_sB').value = arr.stakeB.toFixed(1);
  } else {
    document.getElementById('am_qA').value = '';
    document.getElementById('am_qB').value = '0.00';
    document.getElementById('am_sA').value = '';
    document.getElementById('am_sB').value = '';
  }

  document.getElementById('am_esito').value = 'Non giocata';

  document.getElementById('addModal').style.display = 'flex';
}

function apriAddModalManuale() {
  document.getElementById('am_mode').value = 'manuale';
  document.getElementById('am_title').textContent = 'Nuova riga storico';

  document.getElementById('am_data').value = todayISO();
  document.getElementById('am_partita').value = '';
  document.getElementById('am_tipo').value = 'Asian Line Intera';
  document.getElementById('am_qA').value = '';
  document.getElementById('am_qB').value = '0.00';
  document.getElementById('am_sA').value = '';
  document.getElementById('am_sB').value = '';
  document.getElementById('am_esito').value = 'Non giocata';

  document.getElementById('addModal').style.display = 'flex';
}

function chiudiAddModal() {
  document.getElementById('addModal').style.display = 'none';
}

function calcolaProfitDaRecord(rec) {
  const qA = rec.quotaA;
  const qB = rec.quotaB;
  const sA = rec.stakeA;
  const sB = rec.stakeB;
  const esito = rec.esito;
  const S = sA + sB;

  if (esito === 'Non giocata') return 0;

  // caso speciale: "Solo B vinta" ma stakeB=0 → in realtà hai perso A
  if (esito === 'Solo B vinta' && sB <= 0) {
    return -sA;
  }

  // Caso speciale: Asian Over Live come bet unica
  if (rec.tipo === 'Asian Over Live') {
    let profit = 0;
    switch (esito) {
      case 'Vinte entrambe':
        profit = (sA * (qA - 1)) + (sB * (qB - 1));
        break;
      case 'Perse entrambe':
        profit = -S;
        break;
      case 'Solo A vinta':
        profit = (sA * (qA - 1)) - sB;
        break;
      case 'Solo B vinta':
        // mezza persa: low perde, high void
        profit = -sA;
        break;
      default:
        profit = 0;
        break;
    }
    return roundBook(profit);
  }

  let profit = 0;
  switch (esito) {
    case 'Vinte entrambe':
      profit = (sA * qA + sB * qB) - S;
      break;
    case 'Solo A vinta':
      if (sB > 0 && qB > 1) {
        profit = (sA * qA) - S;
      } else {
        // solo A giocata
        profit = (sA * qA) - sA;
      }
      break;
    case 'Solo B vinta':
      if (sB > 0 && qB > 1 && sA > 0 && qA > 1) {
        profit = (sB * qB) - S;
      } else {
        // solo B giocata
        profit = (sB * qB) - sB;
      }
      break;
    case 'Perse entrambe':
    default:
      profit = -S;
      break;
  }
  return roundBook(profit);
}

function confermaAddModal() {
  const data    = document.getElementById('am_data').value || todayISO();
  const partita = document.getElementById('am_partita').value || '';
  const tipo    = document.getElementById('am_tipo').value;
  const qA      = safeNum(document.getElementById('am_qA').value);
  const qB      = safeNum(document.getElementById('am_qB').value);
  const sA      = safeNum(document.getElementById('am_sA').value);
  const sB      = safeNum(document.getElementById('am_sB').value);
  const esito   = document.getElementById('am_esito').value;

  if (qA <= 0 || (sA + sB) <= 0) {
    alert('Inserisci almeno Quota A e uno stake > 0.');
    return;
  }

  const rec = {
    id: Date.now(),
    data,
    partita,
    tipo,
    quotaA: qA,
    quotaB: qB,
    stakeA: sA,
    stakeB: sB,
    esito,
    profit: 0
  };
  rec.profit = calcolaProfitDaRecord(rec);

  const arr = loadStorico();
  arr.push(rec);
  saveStorico(arr);

  chiudiAddModal();
  renderStorico();
  aggiornaDashboard();
  buildDailySummary();
}

/* ========= MODALE EDIT ========= */
function apriEditModal(id) {
  const arr = loadStorico();
  const rec = arr.find(r => r.id === id);
  if (!rec) return;

  document.getElementById('em_id').value = rec.id;
  document.getElementById('em_data').value = rec.data;
  document.getElementById('em_partita').value = rec.partita || '';
  document.getElementById('em_tipo').value = rec.tipo;
  document.getElementById('em_qA').value = rec.quotaA.toFixed(2);
  document.getElementById('em_qB').value = rec.quotaB ? rec.quotaB.toFixed(2) : '0.00';
  document.getElementById('em_sA').value = rec.stakeA.toFixed(1);
  document.getElementById('em_sB').value = rec.stakeB.toFixed(1);
  document.getElementById('em_esito').value = rec.esito;

  document.getElementById('editModal').style.display = 'flex';
}
function closeEdit() {
  document.getElementById('editModal').style.display = 'none';
}

function saveEdit() {
  const id   = parseInt(document.getElementById('em_id').value, 10);
  const data = document.getElementById('em_data').value || todayISO();
  const partita = document.getElementById('em_partita').value || '';
  const tipo = document.getElementById('em_tipo').value;
  const qA = safeNum(document.getElementById('em_qA').value);
  const qB = safeNum(document.getElementById('em_qB').value);
  const sA = safeNum(document.getElementById('em_sA').value);
  const sB = safeNum(document.getElementById('em_sB').value);
  const esito = document.getElementById('em_esito').value;

  const arr = loadStorico();
  const idx = arr.findIndex(r => r.id === id);
  if (idx === -1) return;

  const rec = {
    id,
    data,
    partita,
    tipo,
    quotaA: qA,
    quotaB: qB,
    stakeA: sA,
    stakeB: sB,
    esito,
    profit: 0
  };
  rec.profit = calcolaProfitDaRecord(rec);
  arr[idx] = rec;
  saveStorico(arr);

  closeEdit();
  renderStorico();
  aggiornaDashboard();
  buildDailySummary();
}

/* ========= Filtri periodo ========= */
function applyPeriodo(arr, periodo) {
  if (periodo === 'tutto') return arr;
  const today = cloneDate(new Date());

  function match(r) {
    if (!r.data) return true;
    const d = cloneDate(new Date(r.data));

    if (periodo === 'oggi') {
      return d.getTime() === today.getTime();
    }
    if (periodo === 'ieri') {
      const y = cloneDate(today);
      y.setDate(y.getDate() - 1);
      return d.getTime() === y.getTime();
    }
    if (periodo === 'sett_corr') {
      const day = today.getDay() || 7;
      const start = cloneDate(today);
      start.setDate(start.getDate() - (day - 1));
      return d >= start;
    }
    if (periodo === 'sett_prev') {
      const day = today.getDay() || 7;
      const monday = cloneDate(today);
      monday.setDate(monday.getDate() - (day - 1));
      const start = cloneDate(monday);
      start.setDate(start.getDate() - 7);
      const end = cloneDate(start);
      end.setDate(end.getDate() + 6);
      return d >= start && d <= end;
    }
    if (periodo === 'mese_corr') {
      return r.data.slice(0,7) === today.toISOString().slice(0,7);
    }
    if (periodo === 'mese_prev') {
      const tmp = cloneDate(today);
      tmp.setMonth(tmp.getMonth() - 1);
      return r.data.slice(0,7) === tmp.toISOString().slice(0,7);
    }
    return true;
  }

  return arr.filter(match);
}

/* ========= Render Storico ========= */
function renderStorico() {
  const box = document.getElementById('storicoBox');
  const all = loadStorico();
  let arr = all.slice();

  const tipo   = document.getElementById('f_tipo').value || 'all';
  const periodo= document.getElementById('f_periodo').value || 'tutto';

  if (tipo !== 'all') arr = arr.filter(r => r.tipo === tipo);
  arr = applyPeriodo(arr, periodo);

  if (!arr.length) {
    box.innerHTML = '<p class="text-gray">Nessuna giocata per i filtri selezionati.</p>';
    return;
  }

  arr.sort((a,b) => (a.data === b.data ? a.id - b.id : (a.data > b.data ? 1 : -1)));

  let html = '';
  arr.forEach(r => {
    const esitoClass = (r.esito === 'Non giocata') ? 'text-amber' : 'text-blue';
    const profClass  = r.profit >= 0 ? 'text-green' : 'text-red';

    const qB = (r.quotaB && r.stakeB > 0) ? r.quotaB.toFixed(2) : '0.00';
    const sB = (r.stakeB && r.stakeB > 0) ? r.stakeB.toFixed(1) : '0.0';

    html += `<div class="storicoCard">
      <div class="topLine">
        <div class="meta">${r.data} · ${r.tipo}</div>
        <button class="btn small secondary" onclick="apriEditModal(${r.id})">✏️ Modifica</button>
      </div>

      <div class="title">${(r.partita && r.partita.trim()) ? r.partita : '-'}</div>

      <div class="grid2">
        <div><b>A</b>: @ ${r.quotaA.toFixed(2)} · ${r.stakeA.toFixed(1)}€</div>
        <div><b>B</b>: @ ${qB} · ${sB}€</div>
      </div>

      <div class="grid2">
        <div><b>Esito</b>: <span class="${esitoClass}">${r.esito}</span></div>
        <div><b>Profitto</b>: <span class="${profClass}">${(r.profit>=0?'+':'') + r.profit.toFixed(2)}€</span></div>
      </div>
    </div>`;
  });

  box.innerHTML = html;
}

/* ========= Range Profit Chart ========= */
function setRange(r) {
  equityRange = r;
  document.querySelectorAll('.rangeBtn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.range === r);
  });
  aggiornaDashboard();
}

/* ========= Dashboard ========= */
function getDashboardFiltered() {
  const all = loadStorico();
  const tipo   = document.getElementById('d_tipo').value || 'all';
  const periodo= document.getElementById('d_periodo').value || 'tutto';

  let arr = all.slice();
  if (tipo !== 'all') arr = arr.filter(r => r.tipo === tipo);
  arr = applyPeriodo(arr, periodo);

  // escludi Non giocata
  arr = arr.filter(r => r.esito !== 'Non giocata');

  // range equity
  const today = cloneDate(new Date());
  arr = arr.filter(r => {
    if (!r.data) return true;
    const d = cloneDate(new Date(r.data));
    const diff = (today - d) / (1000*60*60*24);
    if (equityRange === '1m')  return diff <= 30;
    if (equityRange === '6m')  return diff <= 180;
    if (equityRange === '12m') return diff <= 365;
    return true;
  });

  return { arr, all }; // all = per stake engine
}

function aggiornaDashboard() {
  const {arr, all} = getDashboardFiltered();

  let profit = 0, stakeTot = 0;
  let oddSum = 0, oddCount = 0;
  let matches = arr.length;
  let countA = 0, countB = 0;
  let winA = 0, winB = 0;

  arr.forEach(r => {
    profit += r.profit;
    const stake = r.stakeA + r.stakeB;
    stakeTot += stake;

    if (r.quotaA > 0 && r.stakeA > 0) {
      oddSum += r.quotaA;
      oddCount++;
      countA++;
    }
    if (r.quotaB > 0 && r.stakeB > 0) {
      oddSum += r.quotaB;
      oddCount++;
      countB++;
    }

    const aWin = (r.esito === 'Solo A vinta' || r.esito === 'Vinte entrambe');
    const bWin = (r.esito === 'Solo B vinta' || r.esito === 'Vinte entrambe') && (r.stakeB > 0);

    if (aWin) winA++;
    if (bWin) winB++;
  });

  const totalBets = countA + countB;
  const winsBets  = winA + winB;
  const lostBets  = totalBets - winsBets;

  // KPI
  document.getElementById('kpi_profit').textContent =
    (profit>=0?'+':'') + profit.toFixed(2) + '€';
  document.getElementById('kpi_yield').textContent =
    stakeTot>0 ? ((profit/stakeTot)*100).toFixed(1) + '%' : '-';
  document.getElementById('kpi_odd').textContent =
    oddCount>0 ? (oddSum/oddCount).toFixed(2) : '-';
  document.getElementById('kpi_stake').textContent =
    matches>0 ? (stakeTot/matches).toFixed(2) + '€' : '-';
  document.getElementById('kpi_matches').textContent = matches;
  document.getElementById('kpi_bets').textContent = totalBets;

  const wrTotal = totalBets>0 ? (winsBets/totalBets*100).toFixed(1) : '0.0';
  const wrA = countA>0 ? (winA/countA*100).toFixed(1) : '0.0';
  const wrB = countB>0 ? (winB/countB*100).toFixed(1) : '0.0';

  document.getElementById('kpi_wr_total').textContent = wrTotal + '%';
  document.getElementById('kpi_wr_A').textContent = wrA + '%';
  document.getElementById('kpi_wr_B').textContent = wrB + '%';

  // Donut WinRate
  const won = winsBets;
  const lost = lostBets < 0 ? 0 : lostBets;
  renderWinRateChart(won, lost);

  // Profit chart
  renderProfitChart(arr);

  // Stake engine su TUTTO lo storico (escludendo Non giocata)
  aggiornaStakeEngine(all.filter(r => r.esito !== 'Non giocata'));
}

function renderWinRateChart(won, lost) {
  const tot = won + lost;
  const pWin  = tot ? (won / tot * 100) : 0;
  const pLost = tot ? (lost / tot * 100) : 0;

  document.getElementById('wr_win').textContent  = pWin.toFixed(1) + '%';
  document.getElementById('wr_lost').textContent = pLost.toFixed(1) + '%';

  const ctx = document.getElementById('chartWinRate').getContext('2d');
  if (winChartObj) winChartObj.destroy();

  winChartObj = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Won','Lost'],
      datasets: [{
        data: [won, lost],
        backgroundColor: ['#22c55e', '#ef4444'],
        borderWidth: 0
      }]
    },
    options: {
      cutout: '65%',
      plugins: {
        legend: { display: false },
        tooltip: { enabled: false }
      }
    }
  });
}

function renderProfitChart(arr) {
  const ctx = document.getElementById('chartProfit').getContext('2d');
  if (profitChartObj) profitChartObj.destroy();

  if (!arr.length) {
    profitChartObj = null;
    ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height);
    return;
  }

  const sorted = arr.slice().sort((a,b) => (a.data === b.data ? a.id - b.id : (a.data > b.data ? 1 : -1)));

  const labels = [];
  const values = [];
  let cum = 0;
  sorted.forEach(r => {
    cum += r.profit;
    labels.push(r.data);
    values.push(cum);
  });

  // colore area: verde se equity finale >=0, rosso se <0
  const finale = values[values.length-1];
  const areaColor = finale >= 0 ? 'rgba(34,197,94,0.2)' : 'rgba(239,68,68,0.2)';
  const lineColor = finale >= 0 ? '#22c55e' : '#ef4444';

  profitChartObj = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        data: values,
        fill: true,
        backgroundColor: areaColor,
        borderColor: lineColor,
        borderWidth: 2,
        pointRadius: 0,
        tension: 0.25
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: {
        x: {
          ticks: { display: false },
          grid: { display: false }
        },
        y: {
          ticks: { color: '#6b7280', font: { size: 10 } },
          grid: { color: 'rgba(148,163,184,0.3)' }
        }
      }
    }
  });
}

/* ========= Stake Engine ========= */
function aggiornaStakeEngine(all) {
  const brStartInput = document.getElementById('br_start');
  const brCurEl = document.getElementById('br_current');
  const brDelEl = document.getElementById('br_delta');
  const stkStdEl = document.getElementById('stk_std');
  const stkHighEl = document.getElementById('stk_high');
  const stkNoteEl = document.getElementById('stk_note');

  const brStart = loadBankrollStart();
  if (brStart > 0 && !brStartInput.value) {
    brStartInput.value = brStart.toFixed(2);
  }

  if (brStart <= 0) {
    brCurEl.textContent = '-';
    brDelEl.textContent = 'Imposta un bankroll iniziale per vedere stake consigliate.';
    stkStdEl.textContent = '-';
    stkHighEl.textContent = '-';
    stkNoteEl.textContent = '';
    return;
  }

  let totProfitAll = 0, totStakeAll = 0;
  all.forEach(r => {
    totProfitAll += r.profit;
    totStakeAll += (r.stakeA + r.stakeB);
  });

  const brCurrent = brStart + totProfitAll;
  brCurEl.textContent = brCurrent.toFixed(2) + '€';

  const delta = brCurrent - brStart;
  brDelEl.textContent = (delta>=0?'+':'') + delta.toFixed(2) + '€';

  const STAKE_MIN = Math.max(1, brCurrent * 0.02);
  const STAKE_BASE = brCurrent * 0.05;
  const STAKE_MAX  = brCurrent * 0.10;
  const roiAll = totStakeAll>0 ? (totProfitAll/totStakeAll*100) : 0;

  let f = 0.6;
  if (all.length === 0) {
    f = 0.5;
  } else {
    if (roiAll <= 0) f = 0.6;
    else if (roiAll <= 2) f = 0.7;
    else if (roiAll <= 5) f = 0.8;
    else if (roiAll <= 10) f = 0.9;
    else f = 1.0;
  }

  let stakeStd  = Math.min(Math.max(STAKE_BASE * f, STAKE_MIN), STAKE_MAX);
  let stakeHigh = Math.min(Math.max(STAKE_MAX * f, STAKE_MIN), STAKE_MAX);

  stakeStd  = roundBook(stakeStd);
  stakeHigh = roundBook(stakeHigh);

  stkStdEl.textContent  = stakeStd.toFixed(2) + '€';
  stkHighEl.textContent = stakeHigh.toFixed(2) + '€';

  stkNoteEl.textContent =
    `Stake base teorico (5% BR): ${STAKE_BASE.toFixed(2)}€. ` +
    `Min: ${STAKE_MIN.toFixed(2)}€, Max: ${STAKE_MAX.toFixed(2)}€. ` +
    `Fattore rischio f=${f.toFixed(2)} (basato su ROI & n° giocate).`;
}

/* ========= Riepilogo Giornaliero + Banner ========= */
function buildDailySummary() {
  const box = document.getElementById('dailyBox');
  if (!box) return;

  const scopeSel = document.getElementById('sum_scope');
  const scope = scopeSel ? scopeSel.value : 'day';

  const arrAll = loadStorico().filter(r => r.esito !== 'Non giocata');
  if (!arrAll.length) {
    box.innerHTML = '<p class="text-gray">Nessuna giocata registrata.</p>';
    const banner = document.getElementById('dayBanner');
    if (banner) banner.style.display = 'none';
    return;
  }

  // ordina per data
  arrAll.sort((a,b) => (a.data === b.data ? a.id - b.id : (a.data > b.data ? 1 : -1)));

  // helper key period
  function weekKey(dateStr) {
    // ISO week key: YYYY-Www
    const d = new Date(dateStr);
    d.setHours(0,0,0,0);
    // Thursday in current week decides the year.
    d.setDate(d.getDate() + 3 - ((d.getDay() + 6) % 7));
    const week1 = new Date(d.getFullYear(), 0, 4);
    const weekNo = 1 + Math.round(((d - week1) / 86400000 - 3 + ((week1.getDay() + 6) % 7)) / 7);
    const y = d.getFullYear();
    return `${y}-W${String(weekNo).padStart(2,'0')}`;
  }
  function monthKey(dateStr) {
    return dateStr.slice(0,7); // YYYY-MM
  }

  // raggruppa
  const groups = {};
  arrAll.forEach(r => {
    const key = scope === 'week' ? weekKey(r.data) : (scope === 'month' ? monthKey(r.data) : r.data);
    if (!groups[key]) groups[key] = [];
    groups[key].push(r);
  });

  const keys = Object.keys(groups).sort();

  const brStart = loadBankrollStart();
  let cumProfitBefore = 0;
  const todayStr = todayISO();
  let todayStatus = null;

  let html = '<table class="daily"><tr>' +
    `<th>${scope === 'day' ? 'Data' : (scope === 'week' ? 'Settimana' : 'Mese')}</th>` +
    '<th>Profitto</th><th>Bets</th><th>Winrate</th>' +
    (scope === 'day' ? '<th>Stato</th>' : '<th>ROI</th>') +
    '</tr>';

  keys.forEach(k => {
    const list = groups[k];

    let p = 0;
    let bets = 0, wins = 0;
    let stake = 0;

    list.forEach(r => {
      p += r.profit;
      const sTot = (r.stakeA + r.stakeB);
      stake += sTot;

      // conta bet A/B
      if (r.stakeA > 0 && r.quotaA > 0) {
        bets++;
        if (r.esito === 'Solo A vinta' || r.esito === 'Vinte entrambe') wins++;
      }
      if (r.stakeB > 0 && r.quotaB > 0) {
        bets++;
        if (r.esito === 'Solo B vinta' || r.esito === 'Vinte entrambe') wins++;
      }
    });

    const wr = bets>0 ? (wins/bets*100).toFixed(1) + '%' : '-';

    let lastCol = '';
    if (scope === 'day') {
      let stato = '';
      if (brStart > 0) {
        const brDayStart = brStart + cumProfitBefore;
        const target = brDayStart * 0.03;
        const stop   = brDayStart * 0.10;

        if (p >= target) stato = 'target profit raggiunto';
        else if (p <= -stop) stato = 'stop loss raggiunto';

        if (k === todayStr && stato) todayStatus = stato;
      }
      lastCol = stato;
    } else {
      const roi = stake > 0 ? (p/stake*100) : 0;
      lastCol = (stake>0 ? ((roi>=0?'+':'') + roi.toFixed(1) + '%') : '-');
    }

    html += `<tr>
      <td>${k}</td>
      <td class="${p>=0?'text-green':'text-red'}">${(p>=0?'+':'') + p.toFixed(2)}€</td>
      <td>${bets}</td>
      <td>${wr}</td>
      <td>${lastCol}</td>
    </tr>`;

    // cum profit only makes sense for day
    if (scope === 'day') cumProfitBefore += p;
  });

  html += '</table>';
  box.innerHTML = html;

  // Banner nel tab Calcolatori solo per scope=day
  const banner = document.getElementById('dayBanner');
  if (!banner) return;

  if (scope !== 'day' || !todayStatus) {
    banner.style.display = 'none';
    return;
  }

  banner.style.display = 'block';
  if (todayStatus.indexOf('target') >= 0) {
    banner.className = 'banner green';
    banner.textContent = 'Oggi: ' + todayStatus + '.';
  } else {
    banner.className = 'banner red';
    banner.textContent = 'Oggi: ' + todayStatus + '.';
  }
}

/* ========= Export CSV ========= */
function exportCSV() {
  const arr = loadStorico().slice().sort((a,b) => {
    if (a.data === b.data) return a.id - b.id;
    return a.data < b.data ? -1 : 1;
  });

  if (!arr.length) {
    alert('Nessuna riga da esportare.');
    return;
  }

  const header = ['Data','Tipo','Partita','QuotaA','QuotaB','StakeA','StakeB','Esito','Profitto'];
  const rows = [header.join(';')];

  arr.forEach(r => {
    rows.push([
      r.data,
      r.tipo,
      (r.partita || '').replace(/;/g, ','),
      r.quotaA.toFixed(2),
      r.quotaB ? r.quotaB.toFixed(2) : '0.00',
      r.stakeA.toFixed(2),
      r.stakeB.toFixed(2),
      r.esito,
      r.profit.toFixed(2)
    ].join(';'));
  });

  const blob = new Blob([rows.join('\n')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'bettools_storico.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/* ========= INIT ========= */
document.addEventListener('DOMContentLoaded', () => {
    initTipoSelects();
  showTab('calc');
  renderStorico();
  aggiornaDashboard();
  buildDailySummary();

  const brStart = loadBankrollStart();
  if (brStart > 0) {
    const inp = document.getElementById('br_start');
    if (inp && !inp.value) inp.value = brStart.toFixed(2);
  }

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js').catch(()=>{});
  }
});
</script>

</body>
</html>
