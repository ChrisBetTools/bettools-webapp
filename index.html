<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>BetTools</title>

<!-- iOS PWA -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, system-ui, sans-serif;
        background: #f2f2f7;
        color: #111;
    }

    .topTabs {
        display: flex;
        background: #e5e5ea;
        border-bottom: 1px solid #d1d1d6;
    }
    .topTabs button {
        flex: 1;
        padding: 12px 0;
        background: none;
        border: none;
        font-size: 16px;
        font-weight: 600;
        color: #6e6e73;
    }
    .topTabs button.active {
        color: #007aff;
        border-bottom: 3px solid #007aff;
    }

    .page {
        display: none;
        padding: 16px;
    }

    .card {
        background: #fff;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 18px;
        box-shadow: 0px 4px 15px rgba(0,0,0,0.05);
    }

    label {
        font-size: 14px;
        font-weight: 600;
    }
    input, select {
        width: 100%;
        padding: 10px;
        font-size: 15px;
        border-radius: 8px;
        border: 1px solid #ccc;
        margin-bottom: 12px;
    }

    .btn {
        width: 100%;
        padding: 12px;
        background: #007aff;
        border-radius: 10px;
        color: white;
        font-size: 16px;
        border: none;
        margin-top: 8px;
        cursor: pointer;
    }
    .btn:active { opacity: 0.8; }

    /* KPI (Dashboard) */
    .kpiGrid {
        display: flex;
        flex-wrap: wrap;
        gap: 14px;
    }
    .kpiBox {
        flex: 1 1 140px;
        text-align: left;
    }
    .kpiValue {
        font-size: 22px;
        font-weight: 700;
    }
    .kpiLabel {
        font-size: 13px;
        opacity: 0.7;
    }

    .rangeRow {
        display: flex;
        justify-content: flex-end;
        gap: 6px;
        margin-bottom: 8px;
    }
    .rangeBtn {
        padding: 4px 8px;
        border-radius: 6px;
        border: 1px solid #ccc;
        background: #f2f2f7;
        font-size: 12px;
    }
    .rangeBtn.active {
        background: #007aff;
        color: white;
        border-color: #007aff;
    }

    /* Colori testo */
    .text-red { color: #ff3b30; }
    .text-blue { color: #0a84ff; }
    .text-green { color: #10b981; }
    .text-gray { color: #6b7280; }

    /* Storico */
    .stRow {
        padding: 12px;
        border-bottom: 1px solid #e5e5ea;
    }
</style>

</head>
<body>

<!-- HEADER TABS -->
<div class="topTabs">
    <button id="tab_calc" class="active" onclick="showTab('calc')">Calcolatori</button>
    <button id="tab_storico" onclick="showTab('storico')">Storico</button>
    <button id="tab_dash" onclick="showTab('dash')">Dashboard</button>
</div>

<!-- PAGE: CALCOLATORI -->
<div id="page_calc" class="page" style="display:block;">
<!-- ======================= -->
<!--     ASIAN LINE INTERA   -->
<!-- ======================= -->
<div class="card">
    <h2>Asian Line Intera</h2>

    <label>Puntata Totale (€)</label>
    <input id="al_tot" type="number" step="0.1">

    <label>Quota A (Over Minore)</label>
    <input id="al_qA" type="number" step="0.01">

    <label>Quota B (Over Maggiore)</label>
    <input id="al_qB" type="number" step="0.01">

    <button class="btn" onclick="calcolaAsianIntera()">Calcola</button>

    <div id="al_out" class="card" style="display:none; margin-top:10px;"></div>

    <button class="btn" style="background:#636366" onclick="aggiungiStoricoDaCalc('asian_intera')">
        + Aggiungi allo storico
    </button>
</div>


<!-- ======================= -->
<!--   PROTEZIONE (VOID)     -->
<!-- ======================= -->
<div class="card">
    <h2>Protezione Void (A + B)</h2>

    <label>Puntata Totale (€)</label>
    <input id="pv_tot" type="number" step="0.1">

    <label>Quota A (Giocata Principale)</label>
    <input id="pv_qA" type="number" step="0.01">

    <label>Quota B (Copertura)  
        <small style="opacity:0.6">(Puoi usare 0 se non giocata)</small>
    </label>
    <input id="pv_qB" type="number" step="0.01">

    <button class="btn" onclick="calcolaProtezione()">Calcola</button>

    <div id="pv_out" class="card" style="display:none; margin-top:10px;"></div>

    <button class="btn" style="background:#636366" onclick="aggiungiStoricoDaCalc('protezione')">
        + Aggiungi allo storico
    </button>
</div>



<!-- ======================= -->
<!--   ASIAN FRAZIONARI      -->
<!-- ======================= -->
<div class="card">
    <h2>Over Asiatici Frazionari (0.25 / 0.75)</h2>

    <label>Linea Over</label>
    <select id="af_linea">
        <option value="0.25">Over X.25</option>
        <option value="0.75">Over X.75</option>
    </select>

    <label>Valore X (es. inserisci 2 per Over 2.25 / 2.75)</label>
    <input id="af_base" type="number" step="0.5">

    <label>Puntata Totale (€)</label>
    <input id="af_tot" type="number" step="0.1">

    <label>Quota Minore</label>
    <input id="af_qLow" type="number" step="0.01">

    <label>Quota Maggiore</label>
    <input id="af_qHigh" type="number" step="0.01">

    <button class="btn" onclick="calcolaAsianFraz()">Calcola</button>

    <div id="af_out" class="card" style="display:none; margin-top:10px;"></div>

    <button class="btn" style="background:#636366" onclick="aggiungiStoricoDaCalc('asian_fraz')">
        + Aggiungi allo storico
    </button>
</div>


<!-- FINE BLOCCO CALCOLATORI -->
</div> <!-- chiude page_calc -->
<!-- ======================== -->
<!--        STORICO           -->
<!-- ======================== -->
<div id="page_storico" class="page">

    <div class="card">
        <h2>Storico Giocate</h2>

        <label>Filtra per tipo</label>
        <select id="f_tipo" onchange="renderStorico(); aggiornaDashboard();">
            <option value="all">Tutto</option>
            <option value="asian_intera">Asian Line Intera</option>
            <option value="protezione">Protezione</option>
            <option value="asian_fraz">Asian Frazionari</option>
        </select>

        <label>Filtra per data</label>
        <input type="date" id="f_data" onchange="renderStorico(); aggiornaDashboard();">

        <div id="storicoList" style="margin-top:15px;"></div>

        <button class="btn" style="background:#ff3b30; margin-top:14px;" onclick="resetStorico()">
            Cancella Storico
        </button>

        <button class="btn" style="background:#34c759; margin-top:10px;" onclick="exportCSV()">
            Esporta CSV
        </button>
    </div>

</div> <!-- fine storico -->



<!-- ======================== -->
<!--       DASHBOARD PRO      -->
<!-- ======================== -->
<div id="page_dash" class="page">

    <div class="card">
        <h2>Statistiche Generali</h2>

        <div class="kpiGrid">

            <div class="kpiBox">
                <div class="kpiValue" id="kpi_profit">0€</div>
                <div class="kpiLabel">Total Profit</div>
            </div>

            <div class="kpiBox">
                <div class="kpiValue" id="kpi_yield">0%</div>
                <div class="kpiLabel">Yield</div>
            </div>

            <div class="kpiBox">
                <div class="kpiValue" id="kpi_odd">0</div>
                <div class="kpiLabel">Avg. Odd</div>
            </div>

            <div class="kpiBox">
                <div class="kpiValue" id="kpi_stake">0€</div>
                <div class="kpiLabel">Avg. Stake</div>
            </div>

            <div class="kpiBox">
                <div class="kpiValue" id="kpi_matches">0</div>
                <div class="kpiLabel">Total Matches</div>
            </div>

        </div>
    </div>


    <!-- Donut Chart -->
    <div class="card">
        <h2>Win Rate</h2>
        <canvas id="chartWinRate" height="180"></canvas>
    </div>


    <!-- Profit Chart -->
    <div class="card">
        <h2>Profit Chart</h2>

        <div class="rangeRow">
            <button class="rangeBtn active" data-range="1m" onclick="setRange('1m')">1m</button>
            <button class="rangeBtn" data-range="6m" onclick="setRange('6m')">6m</button>
            <button class="rangeBtn" data-range="12m" onclick="setRange('12m')">12m</button>
            <button class="rangeBtn" data-range="all" onclick="setRange('all')">all</button>
        </div>

        <canvas id="chartProfit" height="260"></canvas>
    </div>


    <!-- Stake Engine -->
    <div class="card">
        <h2>Stake Consigliato</h2>

        <label>Bankroll iniziale (€)</label>
        <input id="br_start" type="number" step="0.1" oninput="saveBankrollStart(); aggiornaDashboard();">

        <p><strong>Bankroll attuale:</strong> <span id="br_current">-</span></p>
        <p><strong>Δ vs iniziale:</strong> <span id="br_delta">-</span></p>

        <p><strong>Stake Standard:</strong> <span id="stk_std">-</span></p>
        <p><strong>Stake High-Edge:</strong> <span id="stk_high">-</span></p>

        <p id="stk_note" class="text-gray" style="font-size:13px; margin-top:10px;"></p>
    </div>

</div> <!-- fine dashboard -->



<!-- ======================== -->
<!--      MODAL EDITOR        -->
<!-- ======================== -->
<div id="editModal"
     style="
       position:fixed; left:0; top:0; width:100%; height:100%;
       background:rgba(0,0,0,0.55); display:none;
       justify-content:center; align-items:center; z-index:999;">
    
    <div class="card" style="max-width:420px; width:90%;">
        <h2>Modifica Giocata</h2>

        <input type="hidden" id="em_id">

        <label>Tipo</label>
        <select id="em_tipo">
            <option value="asian_intera">Asian Line Intera</option>
            <option value="protezione">Protezione</option>
            <option value="asian_fraz">Asian Frazionari</option>
        </select>

        <label>Data</label>
        <input type="date" id="em_data">

        <label>Partita</label>
        <input id="em_partita" type="text">

        <label>Quota A</label>
        <input id="em_qA" type="number" step="0.01">

        <label>Quota B (0 = non giocata)</label>
        <input id="em_qB" type="number" step="0.01">

        <label>Stake A</label>
        <input id="em_sA" type="number" step="0.01">

        <label>Stake B</label>
        <input id="em_sB" type="number" step="0.01">

        <label>Esito</label>
        <select id="em_esito">
            <option value="Non giocata">Non giocata</option>
            <option value="Vinte entrambe">Vinte entrambe</option>
            <option value="Solo A vinta">Solo A vinta</option>
            <option value="Solo B vinta">Solo B vinta</option>
            <option value="Perse entrambe">Perse entrambe</option>
        </select>

        <button class="btn" onclick="saveEdit()">Salva</button>
        <button class="btn" style="background:#ccc; color:#222;" onclick="closeEdit()">Chiudi</button>
    </div>
</div>
<script>
/* ===========================
   COSTANTI & UTILITY
=========================== */
const LS_KEY = 'bettools_history';
const LS_BANKROLL = 'bettools_bankroll_start';

let lastCalc = null;       // usato per asian_intera & protezione & asian_fraz
let equityRange = '1m';    // default range grafico
let winChartObj = null;
let profitChartObj = null;

function safeNum(v) {
    const n = parseFloat(v);
    return isNaN(n) ? 0 : n;
}

function roundBook(x) {
    return Math.round(x * 10) / 10;
}

function todayISO() {
    const d = new Date();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${d.getFullYear()}-${m}-${day}`;
}

/* ===========================
   STORAGE STORICO
=========================== */
function loadStorico() {
    try {
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr)) return [];
        return arr;
    } catch (e) {
        return [];
    }
}

function saveStorico(arr) {
    localStorage.setItem(LS_KEY, JSON.stringify(arr));
}

function resetStorico() {
    if (!confirm("Sei sicuro di cancellare tutto lo storico?")) return;
    localStorage.removeItem(LS_KEY);
    renderStorico();
    aggiornaDashboard();
}

/* ===========================
   STORAGE BANKROLL
=========================== */
function loadBankrollStart() {
    const raw = localStorage.getItem(LS_BANKROLL);
    const v = safeNum(raw);
    return v > 0 ? v : 0;
}

function saveBankrollStart() {
    const v = safeNum(document.getElementById('br_start').value);
    if (v > 0) {
        localStorage.setItem(LS_BANKROLL, v.toString());
    } else {
        localStorage.removeItem(LS_BANKROLL);
    }
}

/* ===========================
   TABS
=========================== */
function showTab(name) {
    const pages = ['calc','storico','dash'];
    pages.forEach(p => {
        document.getElementById('page_' + p).style.display = (p === name ? 'block' : 'none');
    });

    document.getElementById('tab_calc').classList.remove('active');
    document.getElementById('tab_storico').classList.remove('active');
    document.getElementById('tab_dash').classList.remove('active');

    if (name === 'calc') document.getElementById('tab_calc').classList.add('active');
    if (name === 'storico') document.getElementById('tab_storico').classList.add('active');
    if (name === 'dash') document.getElementById('tab_dash').classList.add('active');

    if (name === 'storico' || name === 'dash') {
        renderStorico();
        aggiornaDashboard();
    }
}

/* ===========================
   CALCOLATORE ASIAN INTERA
=========================== */
function calcolaAsianIntera() {
    const S  = safeNum(document.getElementById('al_tot').value);
    const qA = safeNum(document.getElementById('al_qA').value);
    const qB = safeNum(document.getElementById('al_qB').value);
    const out = document.getElementById('al_out');

    if (S <= 0 || qA <= 1 || qB < 0) {
        out.style.display = 'block';
        out.innerHTML = '<span class="text-red">Inserisci puntata valida e Quota A &gt; 1 (Quota B può essere 0 se non giocata).</span>';
        return;
    }

    // Caso Quota B = 0: solo Over Minore
    if (qB === 0) {
        const stakeA = roundBook(S);
        const stakeB = 0;
        const stakeTot = stakeA;
        const profitWin = stakeA * qA - stakeTot;

        out.style.display = 'block';
        out.innerHTML =
            `<p><strong>Punta solo su Over Minore:</strong> ${stakeA.toFixed(1)}€ @ ${qA.toFixed(2)}</p>` +
            `<p><strong>Over Minore vinto:</strong> ${(profitWin >= 0 ? '+' : '') + profitWin.toFixed(2)}€</p>` +
            `<p class="text-gray" style="font-size:13px;">Quota B impostata a 0 → considerata non giocata.</p>`;

        lastCalc = {
            tipo: 'asian_intera',
            quotaA: qA,
            quotaB: 0,
            stakeA,
            stakeB
        };
        return;
    }

    // Caso normale: due over per simulare linea asiatica intera
    let stakeA = S / qA;
    let stakeB = S - stakeA;

    stakeA = roundBook(stakeA);
    stakeB = roundBook(stakeB);
    const stakeTot = stakeA + stakeB;

    const ritornoVoid = stakeA * qA;
    const profitVoid = ritornoVoid - stakeTot;

    const ritornoBoth = stakeA * qA + stakeB * qB;
    const profitBoth = ritornoBoth - stakeTot;

    out.style.display = 'block';
    out.innerHTML =
        `<p><strong>Punta su Over Minore:</strong> ${stakeA.toFixed(1)}€ @ ${qA.toFixed(2)}<br>` +
        `<strong>Punta su Over Maggiore:</strong> ${stakeB.toFixed(1)}€ @ ${qB.toFixed(2)}</p>` +
        `<p><strong>Entrambe Vinte:</strong> ${(profitBoth >= 0 ? '+' : '') + profitBoth.toFixed(2)}€</p>` +
        `<p><strong>Solo Over Minore vinto:</strong> ${(profitVoid >= 0 ? '+' : '') + profitVoid.toFixed(2)}€</p>`;

    lastCalc = {
        tipo: 'asian_intera',
        quotaA: qA,
        quotaB: qB,
        stakeA,
        stakeB
    };
}

/* ===========================
   CALCOLATORE PROTEZIONE
=========================== */
function calcolaProtezione() {
    const S  = safeNum(document.getElementById('pv_tot').value);
    const qA = safeNum(document.getElementById('pv_qA').value);
    const qB = safeNum(document.getElementById('pv_qB').value);
    const out = document.getElementById('pv_out');

    if (S <= 0 || qA <= 1 || qB < 0) {
        out.style.display = 'block';
        out.innerHTML = '<span class="text-red">Inserisci puntata valida e Quota A &gt; 1 (Quota B può essere 0 se non giocata).</span>';
        return;
    }

    // Caso Quota B = 0: nessuna copertura, solo A
    if (qB === 0) {
        const stakeA = roundBook(S);
        const stakeB = 0;
        const stakeTot = stakeA;
        const profitSoloA = stakeA * qA - stakeTot;

        out.style.display = 'block';
        out.innerHTML =
            `<p><strong>Punta solo su A (principale):</strong> ${stakeA.toFixed(1)}€ @ ${qA.toFixed(2)}</p>` +
            `<p><strong>Solo A vinta:</strong> ${(profitSoloA >= 0 ? '+' : '') + profitSoloA.toFixed(2)}€</p>` +
            `<p class="text-gray" style="font-size:13px;">Quota B impostata a 0 → nessuna copertura.</p>`;

        lastCalc = {
            tipo: 'protezione',
            quotaA: qA,
            quotaB: 0,
            stakeA,
            stakeB
        };
        return;
    }

    // Caso con copertura B
    let stakeB = S / (qB - 1);
    if (stakeB > S) stakeB = S;
    let stakeA = S - stakeB;

    stakeA = roundBook(stakeA);
    stakeB = roundBook(stakeB);
    const stakeTot = stakeA + stakeB;

    const profitSoloA = (stakeA * qA) - stakeTot;
    const profitSoloB = (stakeB * qB) - stakeTot;
    const profitEntrambe = (stakeA * qA + stakeB * qB) - stakeTot;

    out.style.display = 'block';
    out.innerHTML =
        `<p><strong>Punta su A (principale):</strong> ${stakeA.toFixed(1)}€ @ ${qA.toFixed(2)}<br>` +
        `<strong>Punta su B (copertura):</strong> ${stakeB.toFixed(1)}€ @ ${qB.toFixed(2)}</p>` +
        `<p><strong>Solo A vinta:</strong> ${(profitSoloA >= 0 ? '+' : '') + profitSoloA.toFixed(2)}€</p>` +
        `<p><strong>Solo B vinta (quasi void):</strong> ${(profitSoloB >= 0 ? '+' : '') + profitSoloB.toFixed(2)}€</p>` +
        `<p><strong>Entrambe Vinte:</strong> ${(profitEntrambe >= 0 ? '+' : '') + profitEntrambe.toFixed(2)}€</p>`;

    lastCalc = {
        tipo: 'protezione',
        quotaA: qA,
        quotaB: qB,
        stakeA,
        stakeB
    };
}

/* ===========================
   ASIAN FRAZIONARI (0.25/0.75)
=========================== */
function testoEsitoAsian(linea, gol) {
    const base = Math.floor(linea);
    const frac = linea - base;
    let prefix = `Ancora ${gol} gol: `;

    if (frac === 0.25) {
        if (gol <= base - 1) return prefix + 'persa';
        if (gol === base)    return prefix + 'mezza persa';
        if (gol === base + 1) return prefix + 'vinta';
        if (gol >= base + 2) return prefix + 'vinta';
    } else if (frac === 0.75) {
        if (gol <= base)     return prefix + 'persa';
        if (gol === base + 1) return prefix + 'mezza vinta';
        if (gol >= base + 2) return prefix + 'vinta';
    } else {
        if (gol < linea)     return prefix + 'persa';
        if (gol === linea)   return prefix + 'rimborsata';
        if (gol > linea)     return prefix + 'vinta';
    }

    return prefix + '—';
}

function calcolaAsianFraz() {
    const selFrac = safeNum(document.getElementById('af_linea').value); // 0.25 o 0.75
    const baseX   = safeNum(document.getElementById('af_base').value);
    const S       = safeNum(document.getElementById('af_tot').value);
    const qLow    = safeNum(document.getElementById('af_qLow').value);
    const qHigh   = safeNum(document.getElementById('af_qHigh').value);
    const out     = document.getElementById('af_out');

    if (S <= 0 || qLow <= 1 || qHigh <= 1 || (selFrac !== 0.25 && selFrac !== 0.75)) {
        out.style.display = 'block';
        out.innerHTML = '<span class="text-red">Inserisci puntata &gt; 0, quote &gt; 1 e scegli correttamente X.25 o X.75.</span>';
        return;
    }

    const lineaCompleta = baseX + selFrac;

    let stakeLow  = roundBook(S / 2);
    let stakeHigh = roundBook(S - stakeLow);
    const stakeTot = stakeLow + stakeHigh;

    let esempi = '';
    const maxGol = baseX + 4;
    for (let g = 0; g <= maxGol; g++) {
        esempi += `<li>${testoEsitoAsian(lineaCompleta, g)}</li>`;
    }

    out.style.display = 'block';
    out.innerHTML =
        `<p><strong>Linea Asiatica:</strong> Over ${lineaCompleta.toFixed(2)}</p>` +
        `<p><strong>Punta su Over ${baseX.toFixed(0)} (più basso):</strong> ${stakeLow.toFixed(1)}€ @ ${qLow.toFixed(2)}<br>` +
        `<strong>Punta su Over ${(baseX + 0.5).toFixed(1)} (più alto):</strong> ${stakeHigh.toFixed(1)}€ @ ${qHigh.toFixed(2)}</p>` +
        `<p class="text-gray" style="font-size:13px;">Stake diviso 50/50 sui due over adiacenti. I payout precisi dipendono dall'esatto numero di gol.</p>` +
        `<p><strong>Esempi esito in base ai gol:</strong></p>` +
        `<ul style="padding-left:18px; font-size:13px;">${esempi}</ul>`;

    lastCalc = {
        tipo: 'asian_fraz',
        quotaA: qLow,
        quotaB: qHigh,
        stakeA: stakeLow,
        stakeB: stakeHigh
    };
}

/* ===========================
   AGGIUNTA ALLO STORICO
=========================== */
function aggiungiStoricoDaCalc(tipo) {
    if (!lastCalc || lastCalc.tipo !== tipo) {
        alert("Prima esegui il calcolo per questo tipo.");
        return;
    }

    const partita = prompt("Inserisci nome partita (es: Inter - Milan):", "");
    const partitaClean = partita ? partita.trim() : '';

    const arr = loadStorico();
    const newId = arr.length ? Math.max(...arr.map(r => r.id || 0)) + 1 : 1;

    const rec = {
        id: newId,
        tipo,
        data: todayISO(),
        partita: partitaClean,
        quotaA: lastCalc.quotaA,
        quotaB: lastCalc.quotaB || 0,
        stakeA: lastCalc.stakeA,
        stakeB: lastCalc.stakeB,
        esito: 'Non giocata',
        profit: 0
    };

    arr.push(rec);
    saveStorico(arr);
    renderStorico();
    aggiornaDashboard();
    alert("Giocata aggiunta allo storico con esito 'Non giocata'.");
}

/* ===========================
   FILTRI STORICO
=========================== */
function getFilteredHistory() {
    const arr = loadStorico();
    const tipoSel = document.getElementById('f_tipo').value;
    const daData  = document.getElementById('f_data').value;

    return arr.filter(r => {
        if (tipoSel !== 'all' && r.tipo !== tipoSel) return false;
        if (daData && r.data < daData) return false;
        return true;
    });
}

/* ===========================
   RENDER STORICO
=========================== */
function renderStorico() {
    const list = document.getElementById('storicoList');
    if (!list) return;

    const arr = getFilteredHistory().slice().sort((a,b) => {
        if (a.data === b.data) return (b.id || 0) - (a.id || 0);
        return (a.data > b.data) ? -1 : 1;
    });

    if (!arr.length) {
        list.innerHTML = '<p class="text-gray">Nessuna giocata per i filtri selezionati.</p>';
        return;
    }

    let html = '';
    arr.forEach(r => {
        const profitStr = (r.profit >= 0 ? '+' : '') + r.profit.toFixed(2) + '€';
        const profitColor = r.profit >= 0 ? 'text-green' : 'text-red';
        const esitoColor  = (r.esito === 'Non giocata') ? 'text-red' : 'text-blue';

        html += `
        <div class="stRow">
            <strong>${r.data} – ${r.partita || '(nessuna partita)'}</strong><br>
            <span class="text-gray" style="font-size:13px;">
                Tipo: ${r.tipo} · QuotaA ${r.quotaA.toFixed(2)}${r.quotaB ? ' / QuotaB ' + r.quotaB.toFixed(2) : ''}
            </span><br>
            <span style="font-size:13px;">
                Stake A: ${r.stakeA.toFixed(2)}€ · Stake B: ${r.stakeB.toFixed(2)}€
            </span><br>
            <span class="${esitoColor}" style="font-size:13px;">
                Esito: ${r.esito}
            </span>
            <span class="${profitColor}" style="font-size:13px; margin-left:8px; font-weight:600;">
                ${profitStr}
            </span><br>
            <button class="btn" style="margin-top:6px; background:#8e8e93;" onclick="openEdit(${r.id})">
                Modifica
            </button>
        </div>`;
    });

    list.innerHTML = html;
}

/* ===========================
   MODALE EDIT
=========================== */
function openEdit(id) {
    const arr = loadStorico();
    const rec = arr.find(r => r.id === id);
    if (!rec) return;

    document.getElementById('em_id').value = rec.id;
    document.getElementById('em_tipo').value = rec.tipo;
    document.getElementById('em_data').value = rec.data;
    document.getElementById('em_partita').value = rec.partita || '';
    document.getElementById('em_qA').value = rec.quotaA.toFixed(2);
    document.getElementById('em_qB').value = rec.quotaB ? rec.quotaB.toFixed(2) : '0.00';
    document.getElementById('em_sA').value = rec.stakeA.toFixed(2);
    document.getElementById('em_sB').value = rec.stakeB.toFixed(2);
    document.getElementById('em_esito').value = rec.esito;

    document.getElementById('editModal').style.display = 'flex';
}

function closeEdit() {
    document.getElementById('editModal').style.display = 'none';
}

function saveEdit() {
    const id   = parseInt(document.getElementById('em_id').value, 10);
    const tipo = document.getElementById('em_tipo').value;
    const data = document.getElementById('em_data').value || todayISO();
    const partita = document.getElementById('em_partita').value || '';

    const qA = safeNum(document.getElementById('em_qA').value);
    const qB = safeNum(document.getElementById('em_qB').value);
    const sA = safeNum(document.getElementById('em_sA').value);
    const sB = safeNum(document.getElementById('em_sB').value);
    const esito = document.getElementById('em_esito').value;

    const arr = loadStorico();
    const idx = arr.findIndex(r => r.id === id);
    if (idx === -1) return;

    const stakeTot = sA + sB;
    let profit = 0;

    switch (esito) {
        case 'Vinte entrambe':
            profit = (sA * qA + sB * qB) - stakeTot;
            break;
        case 'Solo A vinta':
            profit = (sA * qA) - stakeTot;
            break;
        case 'Solo B vinta':
            profit = (sB * qB) - stakeTot;
            break;
        case 'Perse entrambe':
            profit = -stakeTot;
            break;
        case 'Non giocata':
        default:
            profit = 0;
    }

    arr[idx] = {
        id,
        tipo,
        data,
        partita,
        quotaA: qA,
        quotaB: qB,
        stakeA: sA,
        stakeB: sB,
        esito,
        profit
    };

    saveStorico(arr);
    closeEdit();
    renderStorico();
    aggiornaDashboard();
}

/* ===========================
   DASHBOARD & GRAFICI
=========================== */
function setRange(range) {
    equityRange = range;
    document.querySelectorAll('.rangeBtn').forEach(btn => {
        if (btn.dataset.range === range) btn.classList.add('active');
        else btn.classList.remove('active');
    });
    aggiornaDashboard();
}

function aggiornaDashboard() {
    const arrAll = loadStorico();
    const arrBase = getFilteredHistory();

    const today = new Date();
    const arr = arrBase.filter(r => {
        if (!r.data) return true;
        const d = new Date(r.data);
        const diffDays = (today - d) / (1000*60*60*24);
        if (equityRange === '1m')  return diffDays <= 30;
        if (equityRange === '6m')  return diffDays <= 180;
        if (equityRange === '12m') return diffDays <= 365;
        return true;
    });

    let totProfit = 0, totStake = 0, stakeCount = 0;
    let quotaMediaSum = 0, quotaMediaCount = 0;
    let countAll = arr.length;
    let winAny = 0, lostAll = 0;

    arr.forEach(r => {
        totProfit += r.profit;
        const st = r.stakeA + r.stakeB;
        totStake += st;
        if (st > 0) stakeCount++;

        const qMed = r.quotaB ? (r.quotaA + r.quotaB) / 2 : r.quotaA;
        quotaMediaSum += qMed;
        quotaMediaCount++;

        const aWin = (r.esito === 'Vinte entrambe' || r.esito === 'Solo A vinta');
        const bWin = (r.esito === 'Vinte entrambe' || r.esito === 'Solo B vinta');
        const lost = (r.esito === 'Perse entrambe');

        if (aWin || bWin) winAny++;
        if (lost) lostAll++;
    });

    // KPI
    const kpi_profit  = document.getElementById('kpi_profit');
    const kpi_yield   = document.getElementById('kpi_yield');
    const kpi_odd     = document.getElementById('kpi_odd');
    const kpi_stake   = document.getElementById('kpi_stake');
    const kpi_matches = document.getElementById('kpi_matches');

    kpi_profit.textContent = (totProfit >= 0 ? '+' : '') + totProfit.toFixed(1) + '€';

    const roi = totStake > 0 ? (totProfit / totStake) * 100 : 0;
    kpi_yield.textContent = (totStake > 0 ? roi.toFixed(1) + '%' : '-');

    kpi_matches.textContent = countAll;

    kpi_odd.textContent = quotaMediaCount > 0
        ? (quotaMediaSum / quotaMediaCount).toFixed(2)
        : '-';

    const avgStake = stakeCount > 0 ? (totStake / stakeCount) : 0;
    kpi_stake.textContent = stakeCount > 0
        ? avgStake.toFixed(2) + '€'
        : '-';

    // WinRate chart
    const won = winAny;
    const lost = lostAll;
    const other = Math.max(countAll - won - lost, 0);

    const ctxW = document.getElementById('chartWinRate').getContext('2d');
    if (winChartObj) winChartObj.destroy();
    winChartObj = new Chart(ctxW, {
        type: 'doughnut',
        data: {
            labels: ['Won','Lost','Other'],
            datasets: [{
                data: [won, lost, other],
                backgroundColor: ['#10b981','#ef4444','#9ca3af'],
                borderWidth: 1
            }]
        },
        options: {
            cutout: '60%',
            plugins: {
                legend: { display: true, position: 'bottom' }
            }
        }
    });

    // Profit chart
    renderProfitChart(arr);

    // Stake Engine
    const brStart = loadBankrollStart();
    const brStartInput = document.getElementById('br_start');
    const brCurrentEl  = document.getElementById('br_current');
    const brDeltaEl    = document.getElementById('br_delta');
    const stkStdEl     = document.getElementById('stk_std');
    const stkHighEl    = document.getElementById('stk_high');
    const stkNoteEl    = document.getElementById('stk_note');

    if (brStart > 0 && !brStartInput.value) {
        brStartInput.value = brStart.toFixed(2);
    }

    if (brStart <= 0) {
        brCurrentEl.textContent = '-';
        brDeltaEl.textContent   = '-';
        stkStdEl.textContent    = '-';
        stkHighEl.textContent   = '-';
        stkNoteEl.textContent   = 'Imposta un bankroll iniziale per vedere lo stake suggerito.';
        return;
    }

    let totProfitAll = 0;
    arrAll.forEach(r => totProfitAll += r.profit);
    const brCurrent = brStart + totProfitAll;

    brCurrentEl.textContent = brCurrent.toFixed(2) + '€';
    const delta = brCurrent - brStart;
    brDeltaEl.textContent = (delta >= 0 ? '+' : '') + delta.toFixed(2) + '€';

    const STAKE_MIN  = Math.max(1, brCurrent * 0.02);
    const STAKE_BASE = brCurrent * 0.05;
    const STAKE_MAX  = brCurrent * 0.10;

    let f = 0.6;
    if (countAll === 0) {
        f = 0.5;
    } else {
        if (roi <= 0) f = 0.6;
        else if (roi <= 2)  f = 0.7;
        else if (roi <= 5)  f = 0.8;
        else if (roi <= 10) f = 0.9;
        else f = 1.0;
    }

    let stakeStd  = STAKE_BASE * f;
    let stakeHigh = STAKE_MAX * f;

    if (stakeStd  < STAKE_MIN) stakeStd  = STAKE_MIN;
    if (stakeStd  > STAKE_MAX) stakeStd  = STAKE_MAX;
    if (stakeHigh < STAKE_MIN) stakeHigh = STAKE_MIN;
    if (stakeHigh > STAKE_MAX) stakeHigh = STAKE_MAX;

    stakeStd  = roundBook(stakeStd);
    stakeHigh = roundBook(stakeHigh);

    stkStdEl.textContent  = stakeStd.toFixed(2) + '€';
    stkHighEl.textContent = stakeHigh.toFixed(2) + '€';

    stkNoteEl.textContent =
        `Stake base (5% BR): ${STAKE_BASE.toFixed(2)}€. ` +
        `Min: ${roundBook(STAKE_MIN).toFixed(2)}€, Max: ${STAKE_MAX.toFixed(2)}€. ` +
        `Fattore rischio f=${f.toFixed(2)} (basato su ROI & n° giocate).`;
}

function renderProfitChart(arr) {
    const ctx = document.getElementById('chartProfit').getContext('2d');

    const entries = arr.slice().sort((a,b) => {
        if (a.data === b.data) return (a.id||0) - (b.id||0);
        return a.data < b.data ? -1 : 1;
    });

    let labels = [];
    let data = [];
    let cum = 0;

    entries.forEach(r => {
        cum += r.profit;
        labels.push(r.data);
        data.push(cum);
    });

    if (!labels.length) {
        labels = [todayISO()];
        data = [0];
    }

    const finale = data[data.length - 1];
    const areaColor = finale >= 0 ? 'rgba(16,185,129,0.25)' : 'rgba(248,113,113,0.25)';
    const lineColor = finale >= 0 ? '#10b981' : '#ef4444';

    if (profitChartObj) profitChartObj.destroy();
    profitChartObj = new Chart(ctx, {
        type: 'line',
        data: {
            labels,
            datasets: [{
                label: 'Equity',
                data,
                borderColor: lineColor,
                backgroundColor: areaColor,
                tension: 0.25,
                fill: true,
                pointRadius: 0
            }]
        },
        options: {
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    ticks: { autoSkip: true, maxTicksLimit: 6 },
                    grid: { display: false }
                },
                y: {
                    grid: { color: 'rgba(209,213,219,0.4)' }
                }
            }
        }
    });
}

/* ===========================
   EXPORT CSV
=========================== */
function exportCSV() {
    const arr = loadStorico().slice().sort((a,b) => {
        if (a.data === b.data) return (a.id||0) - (b.id||0);
        return a.data < b.data ? -1 : 1;
    });

    if (!arr.length) {
        alert('Nessuna riga da esportare.');
        return;
    }

    const header = ['Data','Tipo','Partita','QuotaA','QuotaB','StakeA','StakeB','Esito','Profitto'];
    const rows = [header.join(';')];

    arr.forEach(r => {
        rows.push([
            r.data,
            r.tipo,
            (r.partita || '').replace(/;/g, ','),
            r.quotaA.toFixed(2),
            r.quotaB ? r.quotaB.toFixed(2) : '0.00',
            r.stakeA.toFixed(2),
            r.stakeB.toFixed(2),
            r.esito,
            r.profit.toFixed(2)
        ].join(';'));
    });

    const blob = new Blob([rows.join('\n')], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'bettools_storico.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

/* ===========================
   INIT
=========================== */
document.addEventListener('DOMContentLoaded', () => {
    showTab('calc');
    renderStorico();
    setRange('1m');   // inizializza range & dashboard
    aggiornaDashboard();

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('service-worker.js').catch(()=>{});
    }
});
</script>
</body>
</html>



